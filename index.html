<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù‡Ø¨ÛŒØª ØªØ±Ú©Ø±</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#4f46e5">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/4305/4305432.png">
    
    <!-- Vazirmatn Font -->
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100..900&display=swap" rel="stylesheet">
    
    <style>
        /* --- VARIABLES --- */
        :root {
            --primary: #4f46e5; /* Indigo 600 */
            --primary-light: #818cf8;
            --primary-bg: #e0e7ff;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            
            /* Theme Colors - Light */
            --bg-body: #f8fafc;
            --bg-surface: #ffffff;
            --bg-card: #ffffff;
            --bg-input: #f1f5f9;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border: #e2e8f0;
            
            --shadow-sm: 0 2px 8px rgba(15, 23, 42, 0.06);
            --shadow-md: 0 12px 28px rgba(15, 23, 42, 0.1);
            --shadow-lg: 0 20px 40px rgba(79, 70, 229, 0.2);
            
            --radius-l: 24px;
            --radius-m: 16px;
            --radius-s: 12px;
        }

        [data-theme="dark"] {
            /* Theme Colors - Dark */
            --bg-body: #0f172a;
            --bg-surface: #1e293b;
            --bg-card: #1e293b;
            --bg-input: #334155;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border: #334155;
            --primary-bg: #312e81;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; font-family: 'Vazirmatn', sans-serif; }

        body {
            font-family: 'Vazirmatn', sans-serif;
            background: radial-gradient(circle at top right, rgba(79, 70, 229, 0.08), transparent 35%), var(--bg-body);
            color: var(--text-main);
            min-height: 100vh;
            line-height: 1.6;
            transition: background 0.3s, color 0.3s;
            padding-bottom: 100px;
            -webkit-font-smoothing: antialiased;
        }

        .app-container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px 16px;
            display: none; /* Hidden until auth check */
        }
        .app-container.visible { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- AUTH SCREEN --- */
        .auth-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-body); z-index: 5000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 24px; text-align: center;
        }
        .auth-logo { width: 80px; height: 80px; background: var(--primary); border-radius: 20px; display: flex; align-items: center; justify-content: center; color: white; margin-bottom: 24px; box-shadow: 0 10px 25px rgba(79, 70, 229, 0.3); }
        .auth-logo svg { width: 40px; height: 40px; }
        .auth-card { background: var(--bg-surface); padding: 30px; border-radius: 24px; width: 100%; max-width: 400px; border: 1px solid var(--border); box-shadow: var(--shadow-md); }
        .auth-tabs { display: flex; margin-bottom: 20px; background: var(--bg-input); padding: 4px; border-radius: 12px; }
        .auth-tab { flex: 1; padding: 10px; border-radius: 10px; border: none; background: transparent; color: var(--text-muted); cursor: pointer; font-weight: 700; transition: all 0.2s; }
        .auth-tab.active { background: var(--bg-surface); color: var(--primary); box-shadow: var(--shadow-sm); }

        /* --- HEADER --- */
        .header {
            margin-bottom: 12px;
            background: linear-gradient(140deg, rgba(79, 70, 229, 0.12), rgba(99, 102, 241, 0.03));
            border: 1px solid rgba(79, 70, 229, 0.16);
            border-radius: 22px;
            padding: 16px;
            box-shadow: var(--shadow-sm);
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .header h1 { font-size: 1.35rem; font-weight: 900; color: var(--text-main); letter-spacing: -0.5px; }
        [data-theme="dark"] .header {
            background: linear-gradient(140deg, rgba(79, 70, 229, 0.24), rgba(30, 41, 59, 0.3));
            border-color: rgba(129, 140, 248, 0.35);
        }
        .header-subtitle { font-size: 0.78rem; color: var(--text-muted); font-weight: 500; margin-top: -6px; margin-bottom: 8px; }
        
        .header-actions { display: flex; gap: 8px; }
        .icon-btn {
            background: var(--bg-surface); border: 1px solid var(--border);
            color: var(--text-muted); width: 38px; height: 38px;
            border-radius: var(--radius-s); display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; cursor: pointer; transition: all 0.2s; position: relative;
        }
        .icon-btn:hover { border-color: var(--text-muted); color: var(--text-main); background: var(--bg-input); }
        .icon-btn svg { width: 20px; height: 20px; stroke-width: 2; }
        .sync-badge { position: absolute; top: -2px; right: -2px; width: 10px; height: 10px; background: var(--warning); border-radius: 50%; border: 2px solid var(--bg-surface); display: none; }
        .icon-btn.unsynced .sync-badge { display: block; }
        .icon-btn.loading svg { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Level Progress */
        .level-container {
            background: rgba(255,255,255,0.88); padding: 12px 16px;
            border-radius: var(--radius-m); border: 1px solid var(--border);
            display: flex; align-items: center; gap: 14px;
            margin-bottom: 14px;
            backdrop-filter: blur(8px);
        }
        [data-theme="dark"] .level-container { background: rgba(30, 41, 59, 0.85); }

        .summary-grid {
            display: grid;
            grid-auto-flow: column;
            grid-auto-columns: minmax(108px, 1fr);
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 4px;
            scrollbar-width: none;
        }
        .summary-grid::-webkit-scrollbar { display: none; }
        @media (min-width: 600px) { .summary-grid { grid-auto-flow: row; grid-template-columns: repeat(4, minmax(0, 1fr)); } }
        .summary-card {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 8px 10px;
            box-shadow: var(--shadow-sm);
        }
        .summary-label { color: var(--text-muted); font-size: 0.72rem; font-weight: 600; }
        .summary-value { color: var(--text-main); font-size: 1.05rem; font-weight: 800; margin-top: 4px; }
        .level-badge {
            background: var(--primary); color: white;
            width: 40px; height: 40px; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-weight: 800; font-size: 1.1rem; flex-shrink: 0;
            box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3);
        }
        .level-info { flex: 1; }
        .level-text { display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 6px; font-weight: 600; color: var(--text-muted); }
        .xp-bar { height: 6px; background: var(--bg-body); border-radius: 10px; overflow: hidden; }
        .xp-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.6s ease; border-radius: 10px; }

        /* --- CALENDAR --- */
        .calendar-widget {
            background: var(--bg-surface);
            border-radius: var(--radius-l);
            box-shadow: var(--shadow-md);
            margin-bottom: 14px;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .calendar-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 12px 6px 12px;
            background: var(--bg-surface);
        }
        .cal-title { font-weight: 800; font-size: 1rem; color: var(--text-main); }
        .cal-nav-btn {
            background: transparent; border: none; width: 32px; height: 32px;
            border-radius: 8px; color: var(--text-muted); cursor: pointer;
            display: flex; align-items: center; justify-content: center; 
        }
        .cal-nav-btn svg { width: 20px; height: 20px; }

        .calendar-grid-wrapper {
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 360px; overflow: hidden;
            padding: 0 6px 6px 6px;
        }
        .calendar-grid-wrapper.collapsed { max-height: 100px; }

        .calendar-grid {
            display: grid; grid-template-columns: repeat(7, 1fr);
            row-gap: 2px; column-gap: 2px;
        }

        .day-header {
            text-align: center; font-size: 0.7rem; color: var(--text-muted);
            padding: 8px 0; font-weight: 500; opacity: 0.7;
        }

        .cal-day {
            min-height: 38px;
            aspect-ratio: 1/0.92;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            border-radius: 10px; cursor: pointer; position: relative;
            transition: all 0.2s; font-size: 0.86rem; font-weight: 700;
            color: var(--text-main); border: 1px solid transparent;
            line-height: 1;
            overflow: hidden;
        }
        .cal-day span { position: relative; z-index: 2; line-height: 1; }
        
        .cal-day.today { color: var(--primary); border-color: var(--primary-light); background: rgba(79,70,229,0.06); }
        
        .cal-day.selected { background: var(--primary); color: white !important; border-color: var(--primary); box-shadow: 0 4px 10px rgba(79, 70, 229, 0.25); }
        .cal-day.today.selected { box-shadow: 0 0 0 2px rgba(255,255,255,0.7) inset, 0 4px 10px rgba(79,70,229,0.25); }
        
        .cal-day.empty { pointer-events: none; }
        
        .cal-dot {
            width: 4px; height: 4px; background: var(--success);
            border-radius: 50%; position: absolute; bottom: 4px;
        }
        .cal-day.selected .cal-dot { background: white; opacity: 0.9; }

        .calendar-toggle {
            display: flex; justify-content: center; padding: 6px; cursor: pointer;
            color: var(--text-muted); background: transparent; border-top: 1px solid var(--border);
        }
        .calendar-toggle svg { width: 18px; height: 18px; transition: transform 0.3s; }
        .calendar-toggle.collapsed svg { transform: rotate(0deg); }
        .calendar-toggle svg { transform: rotate(180deg); }


        /* --- FILTERS --- */
        .categories-filter {
            display: flex; gap: 8px; overflow-x: auto; padding-bottom: 4px; margin-bottom: 20px;
            scrollbar-width: none;
        }
        .categories-filter::-webkit-scrollbar { display: none; }
        
        .cat-btn {
            padding: 8px 14px; border-radius: 12px; border: 1px solid var(--border);
            background: var(--bg-surface); color: var(--text-muted);
            font-size: 0.8rem; white-space: nowrap; cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; gap: 6px; font-weight: 600;
        }
        .cat-dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; }
        
        .cat-btn.active { 
            background: var(--primary); color: white; border-color: var(--primary);
        }
        .cat-btn.active .cat-dot { background: white; }

        .quick-actions { display: flex; gap: 8px; margin-bottom: 10px; overflow-x: auto; padding-bottom: 4px; scrollbar-width: none; }
        .quick-actions::-webkit-scrollbar { display:none; }
        .quick-chip { border: 1px solid var(--border); background: var(--bg-surface); color: var(--text-muted); border-radius: 999px; padding: 7px 12px; font-size: 0.78rem; font-weight: 700; white-space: nowrap; cursor: pointer; }
        .quick-chip.active { background: var(--primary); color: #fff; border-color: var(--primary); }
        .app-container.focus-mode .header-subtitle, .app-container.focus-mode .summary-grid { display: none; }
        .app-container.focus-mode .header { padding-bottom: 10px; }

        /* --- HABIT CARDS --- */
        .list-header {
            margin-bottom: 12px; color: var(--text-muted); font-size: 0.85rem; font-weight: 700;
            display: flex; justify-content: space-between; align-items: center;
        }

        .habits-list { display: flex; flex-direction: column; gap: 12px; }
        
        .habit-card {
            background: var(--bg-surface); border-radius: var(--radius-m);
            padding: 16px; border: 1px solid var(--border); box-shadow: var(--shadow-sm);
            display: flex; flex-direction: column; gap: 12px;
            transition: transform 0.2s; position: relative; overflow: hidden;
        }
        .habit-card:hover { transform: translateY(-2px); }
        .habit-card:active { transform: scale(0.99); }
        .habit-card::before {
            content: ''; position: absolute; right: 0; top: 0; bottom: 0;
            width: 4px; background: var(--card-color);
        }
        
        .habit-header { display: flex; align-items: center; gap: 14px; }
        
        .habit-icon-box {
            width: 48px; height: 48px; border-radius: 14px;
            display: flex; align-items: center; justify-content: center;
            background: var(--bg-input); flex-shrink: 0; color: var(--text-main);
        }
        .habit-icon-box svg { width: 24px; height: 24px; stroke-width: 1.5; }
        
        .habit-info { flex: 1; min-width: 0; }
        .habit-title { font-weight: 700; font-size: 1rem; margin-bottom: 4px; color: var(--text-main); }
        .habit-meta { font-size: 0.75rem; color: var(--text-muted); display: flex; gap: 8px; align-items: center; }
        .habit-badge { 
            background: var(--bg-input); padding: 2px 6px; border-radius: 6px; 
            font-weight: 500; color: var(--text-muted);
        }

        .habit-actions {
            display: flex; justify-content: space-between; align-items: center;
            padding-top: 12px; border-top: 1px solid var(--border);
        }
        
        .action-group { display: flex; gap: 8px; }
        .mini-btn {
            width: 34px; height: 34px; border-radius: 10px; border: none;
            background: transparent; color: var(--text-muted);
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .mini-btn:hover { background: var(--bg-input); color: var(--text-main); }
        .mini-btn svg { width: 18px; height: 18px; }
        
        .check-btn {
            width: 42px; height: 42px; border-radius: 12px;
            border: 2px solid var(--border); background: transparent;
            color: var(--border); display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s;
        }
        .check-btn.checked { background: var(--success); border-color: var(--success); color: white; }
        .check-btn svg { width: 22px; height: 22px; stroke-width: 3; opacity: 0; transform: scale(0.5); transition: all 0.2s; }
        .check-btn.checked svg { opacity: 1; transform: scale(1); }
        
        .play-btn { border-color: var(--primary); color: var(--primary); }
        .play-btn svg { opacity: 1; transform: scale(1); fill: currentColor; width: 16px; height: 16px; stroke: none; }

        /* --- MODALS --- */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2000;
            align-items: flex-end; opacity: 0; transition: opacity 0.3s;
        }
        .modal.active { display: flex; opacity: 1; }
        .modal-content {
            background: var(--bg-surface); width: 100%; max-width: 500px;
            border-top-left-radius: 24px; border-top-right-radius: 24px;
            padding: 24px; max-height: 85vh; overflow-y: auto;
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            margin: 0 auto; box-shadow: 0 -10px 40px rgba(0,0,0,0.1);
        }
        @media (min-width: 600px) {
            .modal { align-items: center; }
            .modal-content { border-radius: 24px; transform: scale(0.95); }
        }
        .modal.active .modal-content { transform: translateY(0); }
        @media (min-width: 600px) { .modal.active .modal-content { transform: scale(1); } }

        /* Forms */
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; color: var(--text-muted); font-weight: 600; font-size: 0.9rem; }
        .form-input, .form-select, textarea.form-input {
            width: 100%; padding: 14px; border: 2px solid var(--border);
            border-radius: 14px; background: var(--bg-input); color: var(--text-main);
            font-size: 1rem; font-family: inherit; transition: border 0.2s;
        }
        .form-input:focus { border-color: var(--primary); outline: none; }


        .btn-row { display: flex; gap: 10px; margin-top: 22px; }
        .btn-primary {
            background: linear-gradient(135deg, #4f46e5, #6366f1);
            color: #fff;
            font-weight: 700;
            border: none;
        }
        .btn-soft {
            background: var(--bg-input);
            border-color: transparent;
            color: var(--text-main);
        }
        .panel {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 14px;
        }
        .modal-title { margin-bottom: 18px; font-size: 1.1rem; font-weight: 800; }
        .settings-list { display: flex; flex-direction: column; gap: 10px; }
        .settings-btn {
            margin-bottom: 0 !important;
            text-align: right;
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-input);
            border-width: 1px;
        }
        .empty-state {
            text-align: center;
            padding: 42px 18px;
            border: 1px dashed var(--border);
            background: var(--bg-surface);
            border-radius: 16px;
            opacity: 0.9;
        }
        .empty-state .emoji { font-size: 2.5rem; margin-bottom: 10px; }

        /* Category Manager */
        .cat-tools { display: grid; grid-template-columns: 1fr auto; gap: 10px; margin-bottom: 14px; }
        .cat-stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 14px; }
        .cat-stat-card { background: var(--bg-input); border: 1px solid var(--border); border-radius: 12px; padding: 10px; text-align: center; }
        .cat-stat-value { font-weight: 800; font-size: 1rem; }
        .cat-stat-label { color: var(--text-muted); font-size: 0.75rem; }
        .cat-list { display: flex; flex-direction: column; gap: 10px; margin-bottom: 16px; max-height: 280px; overflow: auto; padding-left: 4px; }
        .cat-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px; background: var(--bg-input); border-radius: 12px; border: 1px solid var(--border);
        }
        .cat-item-main { display: flex; flex-direction: column; gap: 8px; width: calc(100% - 92px); }
        .cat-info { display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 0.9rem; }
        .cat-usage { color: var(--text-muted); font-size: 0.75rem; font-weight: 500; }
        .cat-color-circle { width: 14px; height: 14px; border-radius: 50%; }
        .cat-edit-row { display: flex; gap: 8px; }
        .cat-edit-input { padding: 8px 10px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg-surface); color: var(--text-main); width: 100%; }
        .cat-actions { display: flex; gap: 6px; }
        .btn-delete-cat, .btn-save-cat { 
            border: none; width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .btn-save-cat { color: var(--success); background: rgba(16, 185, 129, 0.15); }
        .btn-delete-cat { color: var(--danger); background: rgba(239, 68, 68, 0.1); }
        .btn-delete-cat svg, .btn-save-cat svg { width: 17px; height: 17px; stroke-width: 2.2; }
        .add-cat-form { display: flex; gap: 10px; align-items: center; margin-top: 14px; border-top: 1px solid var(--border); padding-top: 14px; }
        .color-picker-wrapper { position: relative; width: 44px; height: 44px; overflow: hidden; border-radius: 12px; border: 2px solid var(--border); flex-shrink: 0; }
        .color-picker-input { position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; cursor: pointer; padding: 0; margin: 0; }

        /* FAB */
        .fab {
            position: fixed; bottom: 30px; left: 24px;
            width: 56px; height: 56px; border-radius: 18px;
            background: linear-gradient(140deg, #4f46e5, #6366f1); color: white; border: none;
            box-shadow: var(--shadow-lg);
            z-index: 100; transition: transform 0.2s; display: flex; align-items: center; justify-content: center;
            cursor: pointer;
        }
        .fab svg { width: 28px; height: 28px; stroke-width: 2.5; }
        .fab:active { transform: scale(0.9); }

        /* Timer Overlay */
        .timer-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-body); z-index: 3000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transform: translateY(100%); transition: transform 0.4s;
        }
        .timer-overlay.active { transform: translateY(0); }
        .timer-circle {
            width: 240px; height: 240px; border-radius: 50%;
            border: 6px solid var(--bg-card); display: flex; align-items: center; justify-content: center;
            margin-bottom: 40px; position: relative; box-shadow: var(--shadow-md);
        }
        .timer-time { font-size: 4rem; font-weight: 900; font-variant-numeric: tabular-nums; color: var(--text-main); }
        .timer-btns { display: flex; gap: 24px; }
        .big-btn {
            width: 64px; height: 64px; border-radius: 20px; border: none;
            font-size: 2rem; color: white; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: transform 0.2s;
        }
        .big-btn:active { transform: scale(0.95); }
        .big-btn svg { width: 28px; height: 28px; fill: currentColor; }

        /* Toast */
        .toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px);
            background: var(--bg-surface); padding: 10px 20px; border-radius: 20px;
            box-shadow: var(--shadow-md); border: 1px solid var(--border);
            z-index: 4000; opacity: 0; transition: all 0.4s; font-weight: 600; white-space: nowrap;
            display: flex; align-items: center; gap: 8px; font-size: 0.9rem;
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

        /* Selectors */
        .days-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .day-checkbox { display: none; }
        .day-label {
            background: var(--bg-input); padding: 12px; border-radius: 12px;
            text-align: center; font-size: 0.9rem; cursor: pointer; border: 2px solid transparent;
            color: var(--text-muted);
        }
        .day-checkbox:checked + .day-label {
            background: var(--primary-bg); border-color: var(--primary); color: var(--primary); font-weight: 700;
        }
        
        .icon-grid { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 8px; scrollbar-width: none; }
        .icon-opt {
            width: 50px; height: 50px; flex-shrink: 0; background: var(--bg-input); color: var(--text-muted);
            border-radius: 14px; display: flex; align-items: center; justify-content: center;
            border: 2px solid transparent; cursor: pointer; transition: all 0.2s;
        }
        .icon-opt svg { width: 24px; height: 24px; stroke-width: 1.5; }
        .icon-opt.selected { border-color: var(--primary); background: var(--primary-bg); color: var(--primary); }
        
        .color-grid { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;}
        .color-opt { width: 40px; height: 40px; border-radius: 50%; border: 3px solid transparent; cursor: pointer; transition: transform 0.2s; }
        .color-opt:hover { transform: scale(1.1); }
        .color-opt.selected { transform: scale(1.15); box-shadow: 0 0 0 2px var(--text-main); }
        
        /* Analytics */
        .chart-container { margin-bottom: 24px; text-align: center; }
        .heatmap-grid { display: grid; grid-template-columns: repeat(20, 1fr); gap: 3px; margin-top: 10px; justify-content: center; }
        .heatmap-cell { aspect-ratio: 1; border-radius: 3px; background: var(--bg-input); }
        .badges-grid { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
    </style>
</head>
<body>
    <!-- AUTH SCREEN -->
    <div class="auth-screen" id="authScreen">
        <div class="auth-logo"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg></div>
        <h2 style="margin-bottom: 8px;">Ø¨Ù‡ Ù‡Ø¨ÛŒØª ØªØ±Ú©Ø± Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯</h2>
        <p style="color:var(--text-muted); margin-bottom:24px;">Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø§Ø¦Ù…ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯</p>
        <div class="auth-card">
            <div class="auth-tabs">
                <button class="auth-tab active" id="tabLogin">ÙˆØ±ÙˆØ¯</button>
                <button class="auth-tab" id="tabRegister">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</button>
            </div>
            <form id="authForm">
                <div class="form-group"><input type="text" id="authUsername" class="form-input" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ" required style="text-align:left;"></div>
                <div class="form-group"><input type="password" id="authPassword" class="form-input" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±" required style="text-align:left;"></div>
                <button type="submit" class="form-input" id="btnAuthSubmit" style="background: var(--primary); color: white; font-weight: bold; border: none; margin-bottom: 12px;">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø­Ø³Ø§Ø¨</button>
                <button type="button" id="btnGuest" style="background: transparent; border: none; color: var(--text-muted); font-size: 0.9rem; cursor: pointer;">Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù…Ù‡Ù…Ø§Ù† (Ø¢ÙÙ„Ø§ÛŒÙ†)</button>
            </form>
        </div>
    </div>

    <div class="app-container" id="appContainer">
        <!-- HEADER -->
        <header class="header">
            <div class="header-top">
                <h1>Ù‡Ø¨ÛŒØª ØªØ±Ú©Ø±</h1>
                <div class="header-actions">
                    <button class="icon-btn" id="btnSync" title="Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ">
                        <div class="sync-badge" id="syncBadge"></div>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></svg>
                    </button>
                    <button class="icon-btn" id="btnAnalytics" title="Ø¢Ù…Ø§Ø±">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>
                    </button>
                    <button class="icon-btn" id="btnSettings" title="ØªÙ†Ø¸ÛŒÙ…Ø§Øª">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                    </button>
                    <button class="icon-btn" id="btnTheme">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
                    </button>
                </div>
            </div>
            <p class="header-subtitle">ØªÙ…Ø±Ú©Ø² Ø§Ù…Ø±ÙˆØ²Øª Ø±Ùˆ Ø­ÙØ¸ Ú©Ù† Ùˆ Ø¨Ø§ Ø±ÛŒØªÙ… Ø«Ø§Ø¨Øª Ø¬Ù„Ùˆ Ø¨Ø±Ùˆ âœ¨</p>
            
            <div class="level-container">
                <div class="level-badge" id="userLevel">1</div>
                <div class="level-info">
                    <div class="level-text">
                        <span id="levelTitle">Ú©Ø§Ø±Ø¨Ø± ØªØ§Ø²Ù‡â€ŒÚ©Ø§Ø±</span>
                        <span id="xpText">0 XP</span>
                    </div>
                    <div class="xp-bar"><div class="xp-fill" id="xpFill"></div></div>
                </div>
            </div>

            <div class="summary-grid">
                <div class="summary-card">
                    <div class="summary-label">Ø¹Ø§Ø¯Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²</div>
                    <div class="summary-value" id="headerHabitCount">Û°</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">ØªÚ©Ù…ÛŒÙ„â€ŒØ´Ø¯Ù‡</div>
                    <div class="summary-value" id="headerCompletedCount">Û°</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">Ø¯Ø±ØµØ¯ Ø§Ù†Ø¬Ø§Ù…</div>
                    <div class="summary-value" id="headerCompletionRate">Û°Ùª</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">Ø±Ú©ÙˆØ±Ø¯ Ù…ØªÙˆØ§Ù„ÛŒ</div>
                    <div class="summary-value" id="headerStreak">Û° Ø±ÙˆØ²</div>
                </div>
            </div>
        </header>

        <!-- FILTERS -->
        <div class="categories-filter" id="catFilters">
            <!-- Generated by JS -->
        </div>
        <div class="quick-actions">
            <button class="quick-chip" id="btnJumpToday">ğŸ“ Ø§Ù…Ø±ÙˆØ²</button>
            <button class="quick-chip" id="btnRandomHabit">ğŸ² Ø¹Ø§Ø¯Øª Ø§ØªÙØ§Ù‚ÛŒ</button>
            <button class="quick-chip" id="btnFocusMode">ğŸ§  Ø­Ø§Ù„Øª ØªÙ…Ø±Ú©Ø²</button>
        </div>

        <!-- CALENDAR WIDGET (New Design) -->
        <div class="calendar-widget">
            <div class="calendar-header">
                <button class="cal-nav-btn" id="prevMonth">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M15 18l-6-6 6-6"/></svg>
                </button>
                <div class="cal-title" id="calTitle">...</div>
                <button class="cal-nav-btn" id="nextMonth">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M9 18l6-6-6-6"/></svg>
                </button>
            </div>
            
            <div class="calendar-grid-wrapper collapsed" id="calWrapper">
                <div class="calendar-grid" id="calendarGrid">
                    <!-- JS will inject headers + days here -->
                </div>
            </div>

            <div class="calendar-toggle collapsed" id="calToggle">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M6 9l6 6 6-6"/></svg>
            </div>
        </div>

        <!-- LIST HEADER -->
        <div class="list-header">
            <span id="dateTitle">Ø§Ù…Ø±ÙˆØ²</span>
            <span id="activeCount">0 Ø¹Ø§Ø¯Øª</span>
        </div>
        <div style="margin-bottom: 12px;">
            <input type="text" id="habitSearchInput" class="form-input" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¨ÛŒÙ† Ø¹Ø§Ø¯Øªâ€ŒÙ‡Ø§...">
        </div>

        <!-- LIST -->
        <div class="habits-list" id="habitsList"></div>
    </div>

    <!-- FAB -->
    <button class="fab" id="btnAddHabit">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
    </button>

    <!-- FORM MODAL -->
    <div class="modal" id="habitModal">
        <div class="modal-content">
            <h3 style="margin-bottom: 24px; text-align: center;">ØªØ¹Ø±ÛŒÙ Ø¹Ø§Ø¯Øª Ø¬Ø¯ÛŒØ¯</h3>
            <form id="habitForm">
                <div class="form-group">
                    <label class="form-label">Ø¹Ù†ÙˆØ§Ù† Ø¹Ø§Ø¯Øª</label>
                    <input type="text" class="form-input" id="habitName" required placeholder="Ù…Ø«Ù„Ø§Ù‹: Ú©ØªØ§Ø¨ Ø®ÙˆØ§Ù†Ø¯Ù†">
                </div>
                <div class="form-group">
                    <label class="form-label">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</label>
                    <select class="form-select" id="habitCategory">
                        <!-- Populated by JS -->
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">ØªÚ©Ø±Ø§Ø±</label>
                    <select class="form-select" id="habitFrequency">
                        <option value="daily">Ù‡Ø± Ø±ÙˆØ²</option>
                        <option value="weekly">Ù‡ÙØªÚ¯ÛŒ (ÙÙ‚Ø· Ø¬Ù…Ø¹Ù‡â€ŒÙ‡Ø§)</option>
                        <option value="custom">Ø±ÙˆØ²Ù‡Ø§ÛŒ Ø®Ø§Øµ (Ø§Ù†ØªØ®Ø§Ø¨ÛŒ)</option>
                    </select>
                </div>
                <div class="form-group" id="customDaysGroup" style="display: none;">
                    <label class="form-label">Ø±ÙˆØ²Ù‡Ø§ÛŒ Ù‡ÙØªÙ‡:</label>
                    <div class="days-grid">
                        <label><input type="checkbox" class="day-checkbox" value="0"><div class="day-label">Ø´</div></label>
                        <label><input type="checkbox" class="day-checkbox" value="1"><div class="day-label">Û±Ø´</div></label>
                        <label><input type="checkbox" class="day-checkbox" value="2"><div class="day-label">Û²Ø´</div></label>
                        <label><input type="checkbox" class="day-checkbox" value="3"><div class="day-label">Û³Ø´</div></label>
                        <label><input type="checkbox" class="day-checkbox" value="4"><div class="day-label">Û´Ø´</div></label>
                        <label><input type="checkbox" class="day-checkbox" value="5"><div class="day-label">ÛµØ´</div></label>
                        <label><input type="checkbox" class="day-checkbox" value="6"><div class="day-label">Ø¬</div></label>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Ø¢ÛŒÚ©ÙˆÙ†</label>
                    <div class="icon-grid" id="iconSelector">
                        <!-- Injected via JS -->
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Ø±Ù†Ú¯</label>
                    <div class="color-grid" id="colorSelector" style="margin-top: 8px;">
                        <div class="color-opt selected" data-color="#4f46e5" style="background:#4f46e5"></div>
                        <div class="color-opt" data-color="#10b981" style="background:#10b981"></div>
                        <div class="color-opt" data-color="#f59e0b" style="background:#f59e0b"></div>
                        <div class="color-opt" data-color="#ef4444" style="background:#ef4444"></div>
                        <div class="color-opt" data-color="#ec4899" style="background:#ec4899"></div>
                        <div class="color-opt" data-color="#06b6d4" style="background:#06b6d4"></div>
                    </div>
                </div>
                <div class="form-group" style="background: var(--bg-input); padding: 12px; border-radius: 12px;">
                    <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; margin-bottom: 0;">
                        <input type="checkbox" id="habitTimer" style="width: 20px; height: 20px;">
                        <span style="font-weight: 600;">ØªØ§ÛŒÙ…Ø± (Ù¾ÙˆÙ…ÙˆØ¯ÙˆØ±Ùˆ)</span>
                    </label>
                    <div id="timerSettings" style="display: none; margin-top: 12px;">
                        <label class="form-label">Ù…Ø¯Øª Ø²Ù…Ø§Ù† (Ø¯Ù‚ÛŒÙ‚Ù‡):</label>
                        <input type="number" id="timerDuration" class="form-input" value="25" min="1" max="180">
                    </div>
                </div>
                <div class="form-group" style="background: var(--bg-input); padding: 12px; border-radius: 12px;">
                    <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; margin-bottom: 0;">
                        <input type="checkbox" id="habitReminder" style="width: 20px; height: 20px;">
                        <span style="font-weight: 600;">ÛŒØ§Ø¯Ø¢ÙˆØ± Ø±ÙˆØ²Ø§Ù†Ù‡</span>
                    </label>
                    <div id="reminderSettings" style="display: none; margin-top: 12px;">
                        <label class="form-label">Ø³Ø§Ø¹Øª ÛŒØ§Ø¯Ø¢ÙˆØ±:</label>
                        <input type="time" id="reminderTime" class="form-input" value="20:00">
                    </div>
                </div>
                <div class="btn-row">
                    <button type="button" class="form-input btn-soft" id="btnCloseModal">Ù„ØºÙˆ</button>
                    <button type="submit" class="form-input btn-primary">Ø°Ø®ÛŒØ±Ù‡</button>
                </div>
            </form>
        </div>
    </div>

    <!-- TIMER COMPLETE MODAL -->
    <div class="modal" id="timerCompleteModal" style="z-index: 3500;">
        <div class="modal-content" style="max-width: 400px; text-align: center; padding-top: 40px;">
            <div style="font-size: 4rem; margin-bottom: 16px;">ğŸ‰</div>
            <h3 style="margin-bottom: 12px;">Ø²Ù…Ø§Ù† ØªÙ…Ø§Ù… Ø´Ø¯!</h3>
            <p style="color: var(--text-muted); margin-bottom: 30px;">ØªÙ…Ø±Ú©Ø² Ø¹Ø§Ù„ÛŒ Ø¨ÙˆØ¯. Ø¢ÛŒØ§ Ø§ÛŒÙ† Ø¹Ø§Ø¯Øª Ø±Ø§ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Â«Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡Â» Ø«Ø¨Øª Ú©Ù†Ù…ØŸ</p>
            <button class="form-input" id="btnConfirmTimer" style="background: var(--primary); color: white; font-weight: bold; font-size: 1.1rem;">Ø¨Ù„Ù‡ØŒ Ø«Ø¨Øª Ú©Ù†</button>
            <button class="form-input" id="btnCancelTimerFinish" style="background: transparent; color: var(--text-muted); margin-top: 10px; border: none;">Ø®ÛŒØ±ØŒ ÙÙ‚Ø· Ø¨Ø¨Ù†Ø¯</button>
        </div>
    </div>

    <!-- GENERIC CONFIRMATION MODAL -->
    <div class="modal" id="confirmModal" style="z-index: 4000;">
        <div class="modal-content" style="max-width: 400px; text-align: center; padding-top: 30px;">
            <div style="font-size: 3rem; margin-bottom: 16px;">âš ï¸</div>
            <h3 id="confirmTitle" style="margin-bottom: 12px;">Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ</h3>
            <p id="confirmMessage" style="color: var(--text-muted); margin-bottom: 30px;">Ø§ÛŒÙ† Ø¹Ù…Ù„ÛŒØ§Øª ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ø§Ø³Øª.</p>
            <button class="form-input" id="btnConfirmYes" style="background: var(--danger); color: white; font-weight: bold; font-size: 1.1rem;">Ø¨Ù„Ù‡</button>
            <button class="form-input" id="btnConfirmNo" style="background: transparent; color: var(--text-muted); margin-top: 10px; border: none;">Ø®ÛŒØ±</button>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <h3 class="modal-title">ØªÙ†Ø¸ÛŒÙ…Ø§Øª</h3>
            
            <div class="panel" style="margin-bottom: 14px; display:flex; align-items:center; justify-content:space-between;">
                <span>ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±: <span id="settingsUser" style="font-weight:bold">Ù…Ù‡Ù…Ø§Ù†</span></span>
                <button id="btnLogout" style="color:var(--danger); border:none; background:none; font-weight:bold; cursor:pointer;">Ø®Ø±ÙˆØ¬</button>
            </div>
            
            <div class="settings-list">
            <button class="form-input settings-btn" id="btnReqNotify">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" width="18"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
                ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†
            </button>
            <button class="form-input settings-btn" id="btnScheduleReminders">â° Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ ÛŒØ§Ø¯Ø¢ÙˆØ±Ù‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²</button>
            <small id="reminderSummary" style="display:block; color:var(--text-muted); margin-top:-4px;">ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ ÙØ¹Ø§Ù„ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</small>

            <button class="form-input settings-btn" id="btnManageCats">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" width="18"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
                Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§
            </button>
            
            <button class="form-input settings-btn" id="btnExport">ğŸ“¤ Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ (Export)</button>
            <button class="form-input settings-btn" id="btnImport">ğŸ“¥ Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ (Import)</button>
            <input type="file" id="fileImport" style="display: none;" accept=".json">
            <button class="form-input settings-btn" id="btnReset" style="background: rgba(239, 68, 68, 0.1); color: var(--danger); border: none;">âš ï¸ Ø­Ø°Ù Ù‡Ù…Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª</button>
            </div>
            <button class="form-input btn-soft" id="btnCloseSettings" style="margin-top: 18px;">Ø¨Ø³ØªÙ†</button>
        </div>
    </div>

    <!-- CATEGORY MANAGER MODAL -->
    <div class="modal" id="categoryModal">
        <div class="modal-content">
            <h3 class="modal-title">Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§</h3>
            <div class="cat-stats">
                <div class="cat-stat-card"><div class="cat-stat-value" id="catCountValue">Û°</div><div class="cat-stat-label">ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§</div></div>
                <div class="cat-stat-card"><div class="cat-stat-value" id="catMostUsedValue">-</div><div class="cat-stat-label">Ù¾Ø±Ø§Ø³ØªÙØ§Ø¯Ù‡â€ŒØªØ±ÛŒÙ†</div></div>
            </div>
            <div class="cat-tools">
                <input type="text" id="catSearchInput" class="form-input" placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ...">
                <button class="form-input btn-soft" id="btnResetCatFilter" style="width:auto; padding: 0 14px;">Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ</button>
            </div>
            <div class="cat-list" id="categoryList">
                <!-- Injected via JS -->
            </div>
            <div class="add-cat-form">
                <input type="text" id="newCatName" class="form-input" placeholder="Ù†Ø§Ù… Ø¯Ø³ØªÙ‡ Ø¬Ø¯ÛŒØ¯">
                <select id="newCatIcon" class="form-select" style="max-width:88px; padding: 8px;"></select>
                <div class="color-picker-wrapper">
                    <input type="color" id="newCatColor" class="color-picker-input" value="#4f46e5">
                </div>
                <button class="icon-btn" id="btnAddCategory" style="background: var(--success); color: white; border: none;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                </button>
            </div>
            <button class="form-input btn-soft" id="btnCloseCatManager" style="margin-top: 20px;">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
        </div>
    </div>

    <!-- ANALYTICS MODAL -->
    <div class="modal" id="analyticsModal">
        <div class="modal-content" style="max-width: 600px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>Ø¢Ù…Ø§Ø± Ø¹Ù…Ù„Ú©Ø±Ø¯</h3>
                <button class="icon-btn" id="btnCloseAnalytics" style="width: 36px; height: 36px; border: none;">âœ•</button>
            </div>
            <div class="chart-container">
                <h4>Ù†Ø±Ø® Ù…ÙˆÙÙ‚ÛŒØª (Û· Ø±ÙˆØ² Ú¯Ø°Ø´ØªÙ‡)</h4>
                <div style="font-size: 2.5rem; font-weight: 900; color: var(--primary); margin: 10px 0;" id="successRateText">0%</div>
                <div style="height: 12px; background: var(--bg-input); border-radius: 6px; overflow: hidden;">
                    <div id="successRateBar" style="height: 100%; width: 0%; background: var(--primary); transition: width 0.8s;"></div>
                </div>
            </div>
            <div class="chart-container">
                <h4>ÙØ¹Ø§Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø³Ø§Ù„Ø§Ù†Ù‡</h4>
                <div class="heatmap-grid" id="heatmapGrid"></div>
            </div>
        </div>
    </div>

    <!-- NOTES MODAL -->
    <div class="modal" id="noteModal">
        <div class="modal-content">
            <h3 class="modal-title">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø±ÙˆØ²Ø§Ù†Ù‡</h3>
            <p id="noteDateDisplay" style="color: var(--text-muted); margin-bottom: 16px; font-size: 0.9rem;"></p>
            <textarea id="noteInput" class="form-input" rows="6" placeholder="ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..."></textarea>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="form-input btn-soft" id="btnCloseNote">Ø¨Ø³ØªÙ†</button>
                <button class="form-input btn-primary" id="btnSaveNote">Ø°Ø®ÛŒØ±Ù‡</button>
            </div>
        </div>
    </div>

    <!-- TIMER OVERLAY -->
    <div class="timer-overlay" id="timerOverlay">
        <div class="timer-circle">
            <span class="timer-time" id="timerDisplay">25:00</span>
        </div>
        <h2 id="timerHabitTitle" style="margin-bottom: 40px;">Ù†Ø§Ù… Ø¹Ø§Ø¯Øª</h2>
        <div class="timer-btns">
            <button class="big-btn" id="btnStopTimer" style="background: var(--danger);">
                <svg viewBox="0 0 24 24"><rect x="6" y="6" width="12" height="12"></rect></svg>
            </button>
            <button class="big-btn" id="btnToggleTimer" style="background: var(--primary);">
                <svg viewBox="0 0 24 24" id="playIcon"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
            </button>
        </div>
        <button id="btnExitTimer" style="margin-top: 40px; background: none; border: none; color: var(--text-muted); font-size: 1rem; padding: 10px 20px;">Ø®Ø±ÙˆØ¬</button>
    </div>

    <div class="toast" id="toast">
        <span>Ù¾ÛŒØ§Ù… Ø³ÛŒØ³ØªÙ…</span>
    </div>

    <script>
        // --- CONFIG ---
        // Ø¢Ø¯Ø±Ø³ ÙˆØ±Ú©Ø± Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ú¯Ø°Ø§Ø±ÛŒØ¯
        const CLOUDFLARE_WORKER_URL = "https://habit.mikasaa.workers.dev";
        // Ú©Ù„ÛŒØ¯ Ø¹Ù…ÙˆÙ…ÛŒ VAPID Ø¨Ø±Ø§ÛŒ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† (Ø§ÛŒÙ† ÛŒÚ© Ú©Ù„ÛŒØ¯ ØªØ³ØªÛŒ Ø§Ø³Øª)
        const VAPID_PUBLIC_KEY = "BOr03M3_a33pZ8F5wZ8q3_d58a58a58a58-a58a58a58a58a58a58a58a58a58a58a58a58a58";

        // --- ICONS & HELPERS ---
        const ICONS = {
            target: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>`,
            book: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>`,
            gym: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M6 7h12M6 17h12M4 5v14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2z"/></svg>`,
            water: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg>`,
            sleep: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>`,
            code: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>`,
            sun: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>`,
            heart: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>`,
            music: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>`,
            pen: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/><circle cx="11" cy="11" r="2"/></svg>`
        };


        const CATEGORY_ICONS = ['ğŸƒ','ğŸ“š','ğŸ’¼','ğŸ§˜','ğŸ’§','ğŸ','ğŸ¯','ğŸ’¡','ğŸ’»','ğŸµ','ğŸ’¤','ğŸ§¹'];
        const getCategoryIcon = cat => cat?.icon || 'ğŸ·ï¸';

        const farsiDigits = ['Û°','Û±','Û²','Û³','Û´','Ûµ','Û¶','Û·','Û¸','Û¹'];
        const toFarsi = n => n.toString().replace(/\d/g, x => farsiDigits[x]);
        const getTodayDate = () => new Date().toISOString().split('T')[0];

        // --- JALALI LOGIC ---
        function toJalaali(gy, gm, gd) {
            var g_d_m = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334];
            var gy2 = (gm > 2) ? (gy + 1) : gy;
            var days = 355666 + (365 * gy) + ~~((gy2 + 3) / 4) - ~~((gy2 + 99) / 100) + ~~((gy2 + 399) / 400) + gd + g_d_m[gm - 1];
            var jy = -1595 + (33 * ~~(days / 12053));
            days %= 12053;
            jy += 4 * ~~(days / 1461);
            days %= 1461;
            if (days > 365) { jy += ~~((days - 1) / 365); days = (days - 1) % 365; }
            var jm, jd;
            if (days < 186) { jm = 1 + ~~(days / 31); jd = 1 + (days % 31); }
            else { jm = 7 + ~~((days - 186) / 30); jd = 1 + ((days - 186) % 30); }
            return { jy: jy, jm: jm, jd: jd };
        }
        function toGregorian(jy, jm, jd) {
            var jy2 = (jy + 1595);
            var days = -355668 + (365 * jy2) + (~~(jy2 / 33) * 8) + ~~(((jy2 % 33) + 3) / 4) + jd + ((jm < 7) ? (jm - 1) * 31 : ((jm - 7) * 30) + 186);
            var gy = 400 * ~~(days / 146097); days %= 146097;
            if (days > 36524) { gy += 100 * ~~(--days / 36524); days %= 36524; if (days >= 365) days++; }
            gy += 4 * ~~(days / 1461); days %= 1461;
            if (days > 365) { gy += ~~((days - 1) / 365); days = (days - 1) % 365; }
            var gd = days + 1;
            var gm = [0, 31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
            if ((gy % 4 === 0 && gy % 100 !== 0) || (gy % 400 === 0)) gm[2] = 29;
            var i;
            for (i = 0; i < 13; i++) { if (gd <= gm[i]) break; gd -= gm[i]; }
            return { gy: gy, gm: i, gd: gd };
        }
        function jalaaliMonthLength(jy, jm) {
            if (jm <= 6) return 31;
            if (jm <= 11) return 30;
            const rem = jy % 33;
            const isLeap = [1, 5, 9, 13, 17, 22, 26, 30].includes(rem); 
            return isLeap ? 30 : 29;
        }

        // --- STATE ---
        let habits = [], userStats = { xp: 0, level: 1 }, categories = [];
        let authState = { token: null, user: 'guest' };
        let editId = null, selectedDate = getTodayDate(), activeFilter = 'all', habitSearchQuery = '';
        let timerInterval = null, timeLeft = 0, isTimerRunning = false, activeTimerHabitId = null;
        let currentNoteId = null;
        let isCalExpanded = false;
        let viewJYear, viewJMonth;
        let pendingConfirmAction = null;
        let isAuthModeLogin = true;

        // --- DOM ELEMENTS ---
        const el = id => document.getElementById(id);
        const els = {
            list: el('habitsList'), modal: el('habitModal'), settings: el('settingsModal'),
            analytics: el('analyticsModal'), note: el('noteModal'), 
            timer: el('timerOverlay'), toast: el('toast'), form: el('habitForm'),
            calGrid: el('calendarGrid'), calTitle: el('calTitle'), calToggle: el('calToggle'),
            calWrapper: el('calWrapper'), catModal: el('categoryModal'), catList: el('categoryList'),
            timerCompleteModal: el('timerCompleteModal'), confirmModal: el('confirmModal'),
            auth: el('authScreen'), app: el('appContainer')
        };

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            initApp();
            // Register SW for Push
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js').then(reg => {
                    console.log('SW Registered', reg);
                });
            }
        });

        function initApp() {
            loadLocalData();
            checkAuth();
            
            const now = new Date();
            const j = toJalaali(now.getFullYear(), now.getMonth()+1, now.getDate());
            viewJYear = j.jy; viewJMonth = j.jm;

            const theme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', theme);
            
            renderIcons();
            updateCategoriesUI();
            renderCalendar();
            renderList();
            updateStats();
            updateReminderSummary();
            const focusOn = localStorage.getItem('focus_mode') === '1';
            els.app.classList.toggle('focus-mode', focusOn);
            setupEvents();
            const focusBtn = el('btnFocusMode'); if (focusBtn) focusBtn.classList.toggle('active', focusOn);
        }

        function loadLocalData() {
            try {
                habits = JSON.parse(localStorage.getItem('habits_ultimate')) || [];
                userStats = JSON.parse(localStorage.getItem('user_stats_ultimate')) || { xp: 0, level: 1 };
                categories = JSON.parse(localStorage.getItem('habit_categories')) || [
                    {id: 'health', name: 'Ø³Ù„Ø§Ù…ØªÛŒ', color: '#10b981', icon:'ğŸƒ'},
                    {id: 'learn', name: 'ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ', color: '#4f46e5', icon:'ğŸ“š'},
                    {id: 'work', name: 'Ú©Ø§Ø±', color: '#f59e0b', icon:'ğŸ’¼'}
                ];
                const t = localStorage.getItem('auth_token');
                const u = localStorage.getItem('auth_user');
                categories = categories.map((c, i) => ({ ...c, icon: c.icon || CATEGORY_ICONS[i % CATEGORY_ICONS.length] }));
                if(t && u) authState = { token: t, user: u };
            } catch(e) { console.error('Load Error', e); }
        }

        // --- AUTH & PUSH ---
        function checkAuth() {
            const isGuest = localStorage.getItem('guest_mode') === 'true';
            if (authState.token || isGuest) {
                els.auth.style.display = 'none';
                els.app.classList.add('visible');
                el('settingsUser').textContent = authState.user;
                if(authState.token) syncData('pull');
            } else {
                els.auth.style.display = 'flex';
                els.app.classList.remove('visible');
            }
        }

        async function handleAuth(e) {
            e.preventDefault();
            const btn = el('btnAuthSubmit');
            const origText = btn.textContent;
            btn.textContent = 'Ù„Ø·ÙØ§ ØµØ¨Ø± Ú©Ù†ÛŒØ¯...';
            btn.disabled = true;

            const u = el('authUsername').value;
            const p = el('authPassword').value;
            const endpoint = isAuthModeLogin ? '/login' : '/register';
            const baseUrl = CLOUDFLARE_WORKER_URL.replace(/\/$/, '');

            try {
                const res = await fetch(`${baseUrl}${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: u, password: p })
                });
                
                let data;
                try { data = await res.json(); } catch(e) { throw new Error("Ù¾Ø§Ø³Ø® Ø³Ø±ÙˆØ± Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª"); }
                
                if (res.ok) {
                    authState = { token: data.token, user: u };
                    localStorage.setItem('auth_token', data.token);
                    localStorage.setItem('auth_user', u);
                    localStorage.removeItem('guest_mode');
                    checkAuth();
                    showToast(isAuthModeLogin ? 'Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯' : 'Ø­Ø³Ø§Ø¨ Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯');
                } else {
                    showToast(data.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø¹Ù…Ù„ÛŒØ§Øª', 'error');
                }
            } catch (err) {
                console.error(err);
                showToast("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±", "error");
            } finally {
                btn.textContent = origText;
                btn.disabled = false;
            }
        }

        async function subscribeToPush() {
            if (!authState.token) return showToast("Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø­Ø³Ø§Ø¨ Ø´ÙˆÛŒØ¯", "error");
            if (!('serviceWorker' in navigator) || !('Notification' in window)) return showToast('Ù…Ø±ÙˆØ±Ú¯Ø± Ø§Ø² Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯', 'error');
            
            const btn = el('btnReqNotify');
            const oldText = btn.textContent;
            btn.textContent = 'Ø¯Ø± Ø­Ø§Ù„ ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ...';

            try {
                const permission = await Notification.requestPermission();
                if (permission !== 'granted') throw new Error('NOTIFICATION_DENIED');

                const reg = await navigator.serviceWorker.ready;
                const existingSub = await reg.pushManager.getSubscription();
                let sub = existingSub;

                if (!sub) {
                    const hasValidVapid = VAPID_PUBLIC_KEY && !VAPID_PUBLIC_KEY.includes('a58a58a58');
                    if (hasValidVapid) {
                        const applicationServerKey = urlBase64ToUint8Array(VAPID_PUBLIC_KEY);
                        sub = await reg.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey });
                    }
                }
                
                if (sub) {
                    const baseUrl = CLOUDFLARE_WORKER_URL.replace(/\/$/, '');
                    const res = await fetch(`${baseUrl}/subscribe`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authState.token}`
                        },
                        body: JSON.stringify(sub)
                    });
                    if (!res.ok) throw new Error('SUBSCRIBE_API_ERROR');
                }

                btn.textContent = 'âœ… Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† ÙØ¹Ø§Ù„ Ø§Ø³Øª';
                showToast('Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ÙØ¹Ø§Ù„ Ø´Ø¯');
            } catch (err) {
                console.error(err);
                btn.textContent = oldText;
                if (err.message === 'NOTIFICATION_DENIED') showToast('Ø¯Ø³ØªØ±Ø³ÛŒ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø±Ø¯ Ø´Ø¯', 'error');
                else showToast('ÙØ¹Ø§Ù„Ø³Ø§Ø²ÛŒ Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯. Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.', 'error');
            }
        }

        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; i++) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        async function syncData(direction = 'push') {
            if (!authState.token) return;
            const btn = el('btnSync');
            btn.classList.add('loading');
            const baseUrl = CLOUDFLARE_WORKER_URL.replace(/\/$/, '');

            try {
                const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authState.token}` };
                
                if (direction === 'push') {
                    await fetch(`${baseUrl}/data`, {
                        method: 'POST', headers,
                        body: JSON.stringify({ habits, userStats, categories, timestamp: Date.now() })
                    });
                    el('syncBadge').style.display = 'none';
                    showToast('Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯');
                } else {
                    const res = await fetch(`${baseUrl}/data`, { headers });
                    if(res.ok) {
                        const data = await res.json();
                        if (data && data.habits) {
                            habits = data.habits; userStats = data.userStats; categories = data.categories || categories;
                            save(false); renderList(); renderCalendar(); updateStats();
                        }
                    }
                }
            } catch (err) {
                console.error("Sync Error", err);
                el('btnSync').classList.add('unsynced');
            } finally {
                btn.classList.remove('loading');
            }
        }

        // --- ORIGINAL APP LOGIC ---
        function renderIcons() {
            const container = el('iconSelector'); container.innerHTML = '';
            Object.keys(ICONS).forEach((key, index) => {
                const div = document.createElement('div');
                div.className = `icon-opt ${index === 0 ? 'selected' : ''}`;
                div.dataset.icon = key; div.innerHTML = ICONS[key];
                div.onclick = function() { document.querySelectorAll('.icon-opt').forEach(x=>x.classList.remove('selected')); this.classList.add('selected'); };
                container.appendChild(div);
            });
        }
        function updateCategoriesUI() {
            const filterContainer = el('catFilters'); filterContainer.innerHTML = ''; 
            const allBtn = document.createElement('button'); allBtn.className = `cat-btn ${activeFilter==='all'?'active':''}`;
            allBtn.innerHTML = 'Ù‡Ù…Ù‡'; allBtn.onclick = () => { activeFilter = 'all'; updateCategoriesUI(); renderList(); };
            filterContainer.appendChild(allBtn);
            categories.forEach(cat => {
                const btn = document.createElement('button'); btn.className = `cat-btn ${activeFilter===cat.id?'active':''}`;
                btn.innerHTML = `<div class="cat-dot" style="color:${cat.color}"></div><span>${getCategoryIcon(cat)}</span>${cat.name}`;
                btn.onclick = () => { activeFilter = cat.id; updateCategoriesUI(); renderList(); };
                filterContainer.appendChild(btn);
            });
            const select = el('habitCategory');
            select.innerHTML = categories.map(c => `<option value="${c.id}">${getCategoryIcon(c)} ${c.name}</option>`).join('');
            if(categories.length === 0) select.innerHTML = `<option value="other">Ø³Ø§ÛŒØ±</option>`;
            const iconSelect = el('newCatIcon');
            if (iconSelect && !iconSelect.options.length) iconSelect.innerHTML = CATEGORY_ICONS.map(i => `<option value="${i}">${i}</option>`).join('');
        }
        function renderCalendar() {
            const months = ['ÙØ±ÙˆØ±Ø¯ÛŒÙ†','Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª','Ø®Ø±Ø¯Ø§Ø¯','ØªÛŒØ±','Ù…Ø±Ø¯Ø§Ø¯','Ø´Ù‡Ø±ÛŒÙˆØ±','Ù…Ù‡Ø±','Ø¢Ø¨Ø§Ù†','Ø¢Ø°Ø±','Ø¯ÛŒ','Ø¨Ù‡Ù…Ù†','Ø§Ø³ÙÙ†Ø¯'];
            els.calTitle.textContent = `${months[viewJMonth-1]} ${toFarsi(viewJYear)}`;
            els.calGrid.innerHTML = '';
            const dayNames = ['Ø´','ÛŒ','Ø¯','Ø³','Ú†','Ù¾','Ø¬'];
            dayNames.forEach(dn => { const dHeader = document.createElement('div'); dHeader.className = 'day-header'; dHeader.textContent = dn; els.calGrid.appendChild(dHeader); });
            const gDateOfFirst = toGregorian(viewJYear, viewJMonth, 1);
            const dObj = new Date(gDateOfFirst.gy, gDateOfFirst.gm - 1, gDateOfFirst.gd, 12, 0, 0);
            const startDayOfWeek = (dObj.getDay() + 1) % 7;
            const monthLen = jalaaliMonthLength(viewJYear, viewJMonth);
            for(let i=0; i<startDayOfWeek; i++) { const cell = document.createElement('div'); cell.className = 'cal-day empty'; els.calGrid.appendChild(cell); }
            for(let d=1; d<=monthLen; d++) {
                const g = toGregorian(viewJYear, viewJMonth, d);
                const isoDate = `${g.gy}-${String(g.gm).padStart(2,'0')}-${String(g.gd).padStart(2,'0')}`;
                const isToday = isoDate === getTodayDate();
                const isSelected = isoDate === selectedDate;
                const hasActivity = habits.some(h => h.completedDates?.includes(isoDate));
                const cell = document.createElement('div');
                cell.className = `cal-day ${isToday?'today':''} ${isSelected?'selected':''}`;
                cell.innerHTML = `<span>${toFarsi(d)}</span>${hasActivity ? '<div class="cal-dot"></div>' : ''}`;
                cell.onclick = () => { selectedDate = isoDate; renderCalendar(); renderList(); };
                els.calGrid.appendChild(cell);
            }
        }
        function renderList() {
            els.list.innerHTML = '';
            const parts = selectedDate.split('-').map(Number);
            const j = toJalaali(parts[0], parts[1], parts[2]);
            const months = ['ÙØ±ÙˆØ±Ø¯ÛŒÙ†','Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª','Ø®Ø±Ø¯Ø§Ø¯','ØªÛŒØ±','Ù…Ø±Ø¯Ø§Ø¯','Ø´Ù‡Ø±ÛŒÙˆØ±','Ù…Ù‡Ø±','Ø¢Ø¨Ø§Ù†','Ø¢Ø°Ø±','Ø¯ÛŒ','Ø¨Ù‡Ù…Ù†','Ø§Ø³ÙÙ†Ø¯'];
            el('dateTitle').textContent = `${toFarsi(j.jd)} ${months[j.jm-1]} ${toFarsi(j.jy)}`;
            const dObj = new Date(selectedDate);
            const pDayIndex = (dObj.getDay() + 1) % 7; 
            const activeHabits = habits.filter(h => {
                if(activeFilter !== 'all' && h.category !== activeFilter) return false;
                if(habitSearchQuery && !h.name.toLowerCase().includes(habitSearchQuery)) return false;
                if(h.frequency === 'daily') return true;
                if(h.frequency === 'weekly') return pDayIndex === 6;
                if(h.frequency === 'custom' && h.customDays) return h.customDays.includes(pDayIndex);
                return true;
            });
            el('activeCount').textContent = `${toFarsi(activeHabits.length)} Ø¹Ø§Ø¯Øª`;
            const completedCount = activeHabits.filter(h => h.completedDates && h.completedDates.includes(selectedDate)).length;
            const headerHabitCountEl = el('headerHabitCount');
            const headerCompletedCountEl = el('headerCompletedCount');
            const headerCompletionRateEl = el('headerCompletionRate');
            const headerStreakEl = el('headerStreak');
            const completionRate = activeHabits.length ? Math.round((completedCount / activeHabits.length) * 100) : 0;
            if (headerHabitCountEl) headerHabitCountEl.textContent = toFarsi(activeHabits.length);
            if (headerCompletedCountEl) headerCompletedCountEl.textContent = toFarsi(completedCount);
            if (headerCompletionRateEl) headerCompletionRateEl.textContent = `${toFarsi(completionRate)}Ùª`;
            if (headerStreakEl) {
                const completedDays = new Set();
                habits.forEach(h => (h.completedDates || []).forEach(d => completedDays.add(d)));
                let streak = 0;
                const cursor = new Date();
                while (true) {
                    const ds = cursor.toISOString().split('T')[0];
                    if (!completedDays.has(ds)) break;
                    streak++;
                    cursor.setDate(cursor.getDate() - 1);
                }
                headerStreakEl.textContent = `${toFarsi(streak)} Ø±ÙˆØ²`;
            }
            if(activeHabits.length === 0) {
                els.list.innerHTML = `<div class="empty-state"><div class="emoji">â˜•</div><p>Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø±ÙˆØ² Ù‡Ù†ÙˆØ² Ø¹Ø§Ø¯ØªÛŒ ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡.</p></div>`; return;
            }
            activeHabits.forEach(h => {
                const isDone = h.completedDates && h.completedDates.includes(selectedDate);
                const category = categories.find(c => c.id === h.category);
                const catName = category ? `${getCategoryIcon(category)} ${category.name}` : 'ğŸ·ï¸ Ø³Ø§ÛŒØ±';
                const card = document.createElement('div'); card.className = 'habit-card';
                let mainBtn = '';
                if(h.hasTimer && !isDone) mainBtn = `<button class="check-btn play-btn" onclick="startTimer('${h.id}')"><svg viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></button>`;
                else mainBtn = `<button class="check-btn ${isDone?'checked':''}" onclick="toggleHabit('${h.id}')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="20 6 9 17 4 12"></polyline></svg></button>`;
                card.innerHTML = `
                    <div class="habit-header">
                        <div class="habit-icon-box" style="color:${h.color}; background:${h.color}15">${ICONS[h.icon]||ICONS.target}</div>
                        <div class="habit-info"><div class="habit-title" style="${isDone?'text-decoration:line-through;opacity:0.5':''}">${h.name}</div><div class="habit-meta"><span class="habit-badge" style="color:${category ? category.color : '#999'}">${catName}</span></div></div>
                    </div>
                    <div class="habit-actions">
                        <div class="action-group">
                            <button class="mini-btn" onclick="editHabit('${h.id}')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
                            <button class="mini-btn" onclick="openNote('${h.id}')" style="${h.notes?.[selectedDate]?'color:var(--primary)':''}"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg></button>
                            <button class="mini-btn" onclick="deleteHabit('${h.id}')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
                        </div>
                        ${mainBtn}
                    </div>`;
                els.list.appendChild(card);
            });
        }
        function save(triggerSync = true) { 
            localStorage.setItem('habits_ultimate', JSON.stringify(habits));
            localStorage.setItem('habit_categories', JSON.stringify(categories));
            localStorage.setItem('user_stats_ultimate', JSON.stringify(userStats));
            if(triggerSync && authState.token) { el('btnSync').classList.add('unsynced'); }
        }
        function toggleHabit(id) { const h = habits.find(x => x.id === id); if(!h.completedDates) h.completedDates = []; const idx = h.completedDates.indexOf(selectedDate); if(idx > -1) { h.completedDates.splice(idx, 1); addXP(-10); } else { h.completedDates.push(selectedDate); addXP(10); showToast('Ø¹Ø§Ù„ÛŒ Ø¨ÙˆØ¯! ğŸ‰'); } save(); renderList(); renderCalendar(); }
        function startTimer(id) { activeTimerHabitId = id; const h = habits.find(x=>x.id===id); el('timerHabitTitle').textContent = h.name; timeLeft = (h.timerDuration || 25) * 60; updateTimerDisplay(); els.timer.classList.add('active'); toggleTimer(true); }
        function toggleTimer(forceStart = false) { const btn = el('btnToggleTimer'); if(!isTimerRunning || forceStart) { if(isTimerRunning && forceStart) clearInterval(timerInterval); isTimerRunning = true; btn.innerHTML = `<svg viewBox="0 0 24 24"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>`; timerInterval = setInterval(() => { timeLeft--; updateTimerDisplay(); if(timeLeft <= 0) { clearInterval(timerInterval); isTimerRunning = false; els.timer.classList.remove('active'); const audio = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg'); audio.play(); els.timerCompleteModal.classList.add('active'); } }, 1000); } else { clearInterval(timerInterval); isTimerRunning = false; btn.innerHTML = `<svg viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>`; } }
        function stopTimerLogic() { clearInterval(timerInterval); isTimerRunning = false; els.timer.classList.remove('active'); activeTimerHabitId = null; }
        function updateTimerDisplay() { const m = Math.floor(timeLeft/60); const s = timeLeft%60; el('timerDisplay').textContent = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`; }
        function addXP(n) { userStats.xp=Math.max(0,userStats.xp+n); updateStats(); }
        function updateStats() {
            const lvl = Math.floor(userStats.xp/100)+1;
            const cur = userStats.xp%100;
            el('userLevel').textContent = toFarsi(lvl);
            el('xpText').textContent = `${toFarsi(cur)} XP`;
            el('xpFill').style.width = `${cur}%`;
        }
        function editHabit(id) { editId=id; const h=habits.find(x=>x.id===id); el('habitName').value=h.name; el('habitFrequency').value=h.frequency; el('habitCategory').value=h.category||'other'; el('habitTimer').checked=h.hasTimer; el('timerDuration').value=h.timerDuration||25; el('habitReminder').checked=!!h.hasReminder; el('reminderTime').value=h.reminderTime||'20:00'; el('customDaysGroup').style.display=h.frequency==='custom'?'block':'none'; el('timerSettings').style.display=h.hasTimer?'block':'none'; el('reminderSettings').style.display=h.hasReminder?'block':'none'; document.querySelectorAll('.day-checkbox').forEach(cb=>cb.checked=h.customDays?.includes(parseInt(cb.value))); document.querySelectorAll('.icon-opt').forEach(i => { i.classList.remove('selected'); if(i.dataset.icon === (h.icon || 'target')) i.classList.add('selected'); }); document.querySelectorAll('.color-opt').forEach(c=>c.classList.toggle('selected', c.dataset.color===h.color)); els.modal.classList.add('active'); }
        function deleteHabit(id) { showConfirm('Ø§ÛŒÙ† Ø¹Ø§Ø¯Øª Ø­Ø°Ù Ø´ÙˆØ¯ØŸ', () => { habits = habits.filter(x => x.id !== id); save(); renderList(); renderCalendar(); updateReminderSummary(); showToast('Ø­Ø°Ù Ø´Ø¯', 'error'); }, 'Ø­Ø°Ù', true); }
        function openNote(id) { currentNoteId = id; const h = habits.find(x => x.id === id); el('noteDateDisplay').textContent = h.name; el('noteInput').value = (h.notes && h.notes[selectedDate]) || ''; els.note.classList.add('active'); }
        function showAnalytics() { els.analytics.classList.add('active'); const grid = el('heatmapGrid'); grid.innerHTML = ''; for(let i=100; i>=0; i--) { const d = new Date(); d.setDate(new Date().getDate() - i); const ds = d.toISOString().split('T')[0]; let count = 0; habits.forEach(h => { if(h.completedDates?.includes(ds)) count++; }); const cell = document.createElement('div'); cell.className = 'heatmap-cell'; if(count>0) cell.style.background = `rgba(79, 70, 229, ${Math.min(1, count*0.4)})`; grid.appendChild(cell); } let total=0, done=0; habits.forEach(h => { for(let i=0; i<7; i++) { const d = new Date(); d.setDate(new Date().getDate()-i); total++; if(h.completedDates?.includes(d.toISOString().split('T')[0])) done++; } }); const rate = total===0?0:Math.round((done/total)*100); el('successRateText').textContent = `${toFarsi(rate)}%`; el('successRateBar').style.width = `${rate}%`; }
        function showConfirm(m, a, t, isD) { el('confirmTitle').textContent = t; el('confirmMessage').textContent = m; el('btnConfirmYes').style.background = isD ? 'var(--danger)' : 'var(--primary)'; pendingConfirmAction = a; els.confirmModal.classList.add('active'); }
        function showToast(m, type='success') { els.toast.innerHTML = m; els.toast.style.borderLeft = `4px solid ${type==='error'?'var(--danger)':'var(--success)'}`; els.toast.classList.add('show'); setTimeout(()=>els.toast.classList.remove('show'),3000); }
        function renderCategoryManager() {
            const q = (el('catSearchInput')?.value || '').trim().toLowerCase();
            const catUsage = id => habits.filter(h => h.category === id).length;
            const visibleCategories = categories.filter(c => c.name.toLowerCase().includes(q));

            el('catCountValue').textContent = toFarsi(categories.length);
            const mostUsed = categories.slice().sort((a,b) => catUsage(b.id) - catUsage(a.id))[0];
            el('catMostUsedValue').textContent = mostUsed ? `${mostUsed.name} (${toFarsi(catUsage(mostUsed.id))})` : '-';

            els.catList.innerHTML = '';
            if (visibleCategories.length === 0) {
                els.catList.innerHTML = `<div class="empty-state" style="padding:18px;"><p>Ø¯Ø³ØªÙ‡â€ŒØ§ÛŒ Ø¨Ø§ Ø§ÛŒÙ† Ù†Ø§Ù… Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.</p></div>`;
                return;
            }
            visibleCategories.forEach(cat => {
                const usage = catUsage(cat.id);
                const item = document.createElement('div');
                item.className = 'cat-item';
                item.innerHTML = `
                    <div class="cat-item-main">
                        <div class="cat-info"><div class="cat-color-circle" style="background:${cat.color}"></div><span>${getCategoryIcon(cat)} ${cat.name}</span></div>
                        <div class="cat-usage">${toFarsi(usage)} Ø¹Ø§Ø¯Øª Ø¯Ø± Ø§ÛŒÙ† Ø¯Ø³ØªÙ‡</div>
                        <div class="cat-edit-row">
                            <input class="cat-edit-input" value="${cat.name}" data-role="name" />
                            <select class="cat-edit-input" data-role="icon" style="width:62px; padding:4px;">${CATEGORY_ICONS.map(ic => `<option value="${ic}" ${ic===getCategoryIcon(cat)?"selected":""}>${ic}</option>`).join('')}</select>
                            <input type="color" class="cat-edit-input" value="${cat.color}" data-role="color" style="width:52px; padding:2px;" />
                        </div>
                    </div>
                    <div class="cat-actions">
                        <button class="btn-save-cat" title="Ø°Ø®ÛŒØ±Ù‡" data-save-id="${cat.id}"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="20 6 9 17 4 12"></polyline></svg></button>
                        <button class="btn-delete-cat" title="Ø­Ø°Ù" data-delete-id="${cat.id}"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
                    </div>`;
                els.catList.appendChild(item);
            });
        }
        function updateReminderSummary() {
            const total = habits.filter(h => h.hasReminder && h.reminderTime).length;
            el('reminderSummary').textContent = total ? `${toFarsi(total)} ÛŒØ§Ø¯Ø¢ÙˆØ± ÙØ¹Ø§Ù„ ØªØ¹Ø±ÛŒÙ Ø´Ø¯Ù‡ Ø§Ø³Øª.` : 'ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ ÙØ¹Ø§Ù„ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.';
        }
        function scheduleTodaysReminders() {
            if (!('Notification' in window)) return showToast('Ù…Ø±ÙˆØ±Ú¯Ø± Ø§Ø² Ø§Ø¹Ù„Ø§Ù† Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯', 'error');
            if (Notification.permission !== 'granted') return showToast('Ø§Ø¨ØªØ¯Ø§ Ø§Ø¹Ù„Ø§Ù† Ø±Ø§ ÙØ¹Ø§Ù„ Ú©Ù†ÛŒØ¯', 'error');
            const now = new Date();
            let count = 0;
            habits.forEach(h => {
                if (!h.hasReminder || !h.reminderTime) return;
                const [hour, minute] = h.reminderTime.split(':').map(Number);
                const reminderDate = new Date();
                reminderDate.setHours(hour, minute, 0, 0);
                const delay = reminderDate.getTime() - now.getTime();
                if (delay <= 0) return;
                count++;
                setTimeout(() => {
                    new Notification(`ÛŒØ§Ø¯Ø¢ÙˆØ± Ø¹Ø§Ø¯Øª: ${h.name}`, { body: `Ø²Ù…Ø§Ù† Ø§Ù†Ø¬Ø§Ù… Â«${h.name}Â» Ø±Ø³ÛŒØ¯ ğŸ’ª` });
                }, delay);
            });
            showToast(count ? `${toFarsi(count)} ÛŒØ§Ø¯Ø¢ÙˆØ± Ø¨Ø±Ø§ÛŒ Ø§Ù…Ø±ÙˆØ² Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ø´Ø¯` : 'Ø¨Ø±Ø§ÛŒ Ø§Ù…Ø±ÙˆØ² ÛŒØ§Ø¯Ø¢ÙˆØ± Ø¢ÛŒÙ†Ø¯Ù‡â€ŒØ§ÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯', count ? 'success' : 'error');
        }
        function jumpToToday() {
            selectedDate = getTodayDate();
            const t = new Date();
            const j = toJalaali(t.getFullYear(), t.getMonth()+1, t.getDate());
            viewJYear = j.jy; viewJMonth = j.jm;
            renderCalendar();
            renderList();
            showToast('Ø¨Ù‡ Ø§Ù…Ø±ÙˆØ² Ø¨Ø±Ú¯Ø´ØªÛŒ ğŸ“');
        }
        function runRandomHabit() {
            const dObj = new Date(selectedDate);
            const pDayIndex = (dObj.getDay() + 1) % 7;
            const candidates = habits.filter(h => {
                if(activeFilter !== 'all' && h.category !== activeFilter) return false;
                if(habitSearchQuery && !h.name.toLowerCase().includes(habitSearchQuery)) return false;
                if(h.frequency === 'daily') return true;
                if(h.frequency === 'weekly') return pDayIndex === 6;
                if(h.frequency === 'custom' && h.customDays) return h.customDays.includes(pDayIndex);
                return true;
            });
            if (!candidates.length) return showToast('Ø¹Ø§Ø¯Øª ÙØ¹Ø§Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†ÛŒØ³Øª', 'error');
            const selected = candidates[Math.floor(Math.random()*candidates.length)];
            showToast(`Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø§Ù…Ø±ÙˆØ²: ${selected.name}`);
            if (selected.hasTimer) startTimer(selected.id);
        }
        function toggleFocusMode() {
            els.app.classList.toggle('focus-mode');
            const enabled = els.app.classList.contains('focus-mode');
            localStorage.setItem('focus_mode', enabled ? '1' : '0');
            const btn = el('btnFocusMode');
            if (btn) btn.classList.toggle('active', enabled);
            showToast(enabled ? 'Ø­Ø§Ù„Øª ØªÙ…Ø±Ú©Ø² ÙØ¹Ø§Ù„ Ø´Ø¯' : 'Ø­Ø§Ù„Øª ØªÙ…Ø±Ú©Ø² ØºÛŒØ±ÙØ¹Ø§Ù„ Ø´Ø¯');
        }
        
        // --- EVENT BINDING ---
        function setupEvents() {
            el('tabLogin').onclick = () => { isAuthModeLogin=true; el('tabLogin').classList.add('active'); el('tabRegister').classList.remove('active'); el('btnAuthSubmit').textContent='ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø­Ø³Ø§Ø¨'; };
            el('tabRegister').onclick = () => { isAuthModeLogin=false; el('tabRegister').classList.add('active'); el('tabLogin').classList.remove('active'); el('btnAuthSubmit').textContent='Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…'; };
            el('authForm').onsubmit = handleAuth;
            el('btnGuest').onclick = () => { localStorage.setItem('guest_mode', 'true'); authState.user='Ù…Ù‡Ù…Ø§Ù†'; checkAuth(); };
            el('btnLogout').onclick = () => { localStorage.removeItem('auth_token'); localStorage.removeItem('auth_user'); localStorage.removeItem('guest_mode'); authState={token:null, user:'guest'}; checkAuth(); window.location.reload(); };
            el('btnSync').onclick = () => syncData('push');
            el('calToggle').onclick = () => { isCalExpanded = !isCalExpanded; els.calWrapper.className = `calendar-grid-wrapper ${isCalExpanded?'':'collapsed'}`; els.calToggle.className = `calendar-toggle ${isCalExpanded?'':'collapsed'}`; };
            el('prevMonth').onclick = () => { viewJMonth--; if(viewJMonth < 1) { viewJMonth = 12; viewJYear--; } renderCalendar(); };
            el('nextMonth').onclick = () => { viewJMonth++; if(viewJMonth > 12) { viewJMonth = 1; viewJYear++; } renderCalendar(); };
            el('btnAddHabit').onclick = () => { editId=null; els.form.reset(); el('customDaysGroup').style.display='none'; el('timerSettings').style.display='none'; el('reminderSettings').style.display='none'; els.modal.classList.add('active'); };
            el('btnCloseModal').onclick = () => els.modal.classList.remove('active');
            el('habitFrequency').onchange = (e) => el('customDaysGroup').style.display = e.target.value==='custom'?'block':'none';
            el('habitTimer').onchange = (e) => el('timerSettings').style.display = e.target.checked?'block':'none';
            el('habitReminder').onchange = (e) => el('reminderSettings').style.display = e.target.checked?'block':'none';
            el('btnToggleTimer').onclick = () => toggleTimer();
            el('btnStopTimer').onclick = () => showConfirm('ØªÙˆÙ‚Ù ØªØ§ÛŒÙ…Ø±ØŸ', stopTimerLogic, 'Ù‡Ø´Ø¯Ø§Ø±', true);
            el('btnExitTimer').onclick = () => showConfirm('Ø®Ø±ÙˆØ¬ØŸ', stopTimerLogic, 'Ù‡Ø´Ø¯Ø§Ø±', true);
            el('btnConfirmTimer').onclick = () => { const h = habits.find(x=>x.id===activeTimerHabitId); if(h && !h.completedDates.includes(selectedDate)) { h.completedDates.push(selectedDate); addXP(20); showToast('Ø«Ø¨Øª Ø´Ø¯!'); save(); renderList(); } els.timerCompleteModal.classList.remove('active'); activeTimerHabitId = null; };
            el('btnCancelTimerFinish').onclick = () => { els.timerCompleteModal.classList.remove('active'); activeTimerHabitId = null; }
            el('btnAnalytics').onclick = showAnalytics; el('btnCloseAnalytics').onclick = () => els.analytics.classList.remove('active');
            el('btnCloseNote').onclick = () => els.note.classList.remove('active');
            el('btnSaveNote').onclick = () => { const h = habits.find(x=>x.id===currentNoteId); if(!h.notes) h.notes = {}; const val = el('noteInput').value.trim(); if(val) h.notes[selectedDate] = val; else delete h.notes[selectedDate]; save(); renderList(); els.note.classList.remove('active'); };
            el('btnSettings').onclick = () => els.settings.classList.add('active'); el('btnCloseSettings').onclick = () => els.settings.classList.remove('active');
            el('btnManageCats').onclick = () => { renderCategoryManager(); els.catModal.classList.add('active'); }; el('btnCloseCatManager').onclick = () => els.catModal.classList.remove('active');
            el('btnTheme').onclick = () => { const next = document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark'; document.documentElement.setAttribute('data-theme', next); localStorage.setItem('theme', next); };
            el('btnExport').onclick = () => { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify({habits, userStats, categories})], {type:'application/json'})); a.download = `backup-${getTodayDate()}.json`; a.click(); };
            el('btnImport').onclick = () => el('fileImport').click();
            el('fileImport').onchange = (e) => { const r = new FileReader(); r.onload = (ev) => { try { const d = JSON.parse(ev.target.result); if(d.habits) { habits=d.habits; userStats=d.userStats||userStats; categories=(d.categories||categories).map((c, i) => ({ ...c, icon: c.icon || CATEGORY_ICONS[i % CATEGORY_ICONS.length] })); save(); updateCategoriesUI(); renderList(); renderCalendar(); updateStats(); updateReminderSummary(); alert('Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø´Ø¯'); } } catch { alert('ÙØ§ÛŒÙ„ Ù†Ø§Ù…Ø¹ØªØ¨Ø±'); } }; if(e.target.files[0]) r.readAsText(e.target.files[0]); };
            el('btnReset').onclick = () => { showConfirm('Ø­Ø°Ù Ú©Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§ØªØŸ', () => { habits = []; userStats = { xp: 0, level: 1 }; save(); updateStats(); renderList(); renderCalendar(); els.settings.classList.remove('active'); }, 'Ù‡Ø´Ø¯Ø§Ø±', true); };
            el('btnConfirmYes').onclick = () => { if(pendingConfirmAction) pendingConfirmAction(); els.confirmModal.classList.remove('active'); pendingConfirmAction = null; };
            el('btnConfirmNo').onclick = () => { els.confirmModal.classList.remove('active'); pendingConfirmAction = null; };
            el('btnAddCategory').onclick = () => { const name = el('newCatName').value.trim(); const color = el('newCatColor').value; const icon = el('newCatIcon').value || 'ğŸ·ï¸'; if(!name) return showToast('Ù†Ø§Ù… Ø¯Ø³ØªÙ‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error'); if(categories.some(c => c.name === name)) return showToast('Ø§ÛŒÙ† Ø¯Ø³ØªÙ‡ Ù‚Ø¨Ù„Ø§ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡', 'error'); categories.push({ id: 'cat_' + Date.now(), name, color, icon }); el('newCatName').value = ''; updateCategoriesUI(); renderCategoryManager(); save(); };
            el('btnReqNotify').onclick = subscribeToPush;
            el('btnScheduleReminders').onclick = scheduleTodaysReminders;
            el('catSearchInput').oninput = renderCategoryManager;
            el('btnResetCatFilter').onclick = () => { el('catSearchInput').value = ''; renderCategoryManager(); };
            el('habitSearchInput').oninput = (e) => { habitSearchQuery = e.target.value.trim().toLowerCase(); renderList(); };
            el('btnJumpToday').onclick = jumpToToday;
            el('btnRandomHabit').onclick = runRandomHabit;
            el('btnFocusMode').onclick = toggleFocusMode;
            els.catList.onclick = (e) => {
                const saveId = e.target.closest('[data-save-id]')?.dataset.saveId;
                const deleteId = e.target.closest('[data-delete-id]')?.dataset.deleteId;
                if (saveId) {
                    const item = e.target.closest('.cat-item');
                    const name = item.querySelector('[data-role="name"]').value.trim();
                    const color = item.querySelector('[data-role="color"]').value;
                    const icon = item.querySelector('[data-role="icon"]').value;
                    if (!name) return showToast('Ù†Ø§Ù… Ø¯Ø³ØªÙ‡ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯', 'error');
                    const cat = categories.find(c => c.id === saveId);
                    if (cat) { cat.name = name; cat.color = color; cat.icon = icon; save(); updateCategoriesUI(); renderCategoryManager(); renderList(); showToast('Ø¯Ø³ØªÙ‡ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯'); }
                }
                if (deleteId) window.deleteCategory(deleteId);
            };
            // Handle form submit
            els.form.onsubmit = (e) => {
                e.preventDefault();
                const name = el('habitName').value; const freq = el('habitFrequency').value; const cat = el('habitCategory').value;
                const hasTimer = el('habitTimer').checked; const timerDur = parseInt(el('timerDuration').value) || 25;
                const hasReminder = el('habitReminder').checked; const reminderTime = el('reminderTime').value || '20:00';
                const icon = document.querySelector('.icon-opt.selected').dataset.icon; const color = document.querySelector('.color-opt.selected').dataset.color;
                let customDays = []; if(freq==='custom') document.querySelectorAll('.day-checkbox:checked').forEach(cb=>customDays.push(parseInt(cb.value)));
                if(editId) { const h = habits.find(x=>x.id===editId); Object.assign(h, {name, frequency:freq, category:cat, customDays, icon, color, hasTimer, timerDuration:timerDur, hasReminder, reminderTime}); }
                else { habits.push({ id:Date.now().toString(), name, frequency:freq, category:cat, customDays, icon, color, hasTimer, timerDuration:timerDur, hasReminder, reminderTime, completedDates:[], notes:{} }); }
                save(); updateReminderSummary(); els.modal.classList.remove('active'); renderList(); renderCalendar();
            };
            window.deleteCategory = function(id) { const linkedHabits = habits.filter(h => h.category === id).length; if (linkedHabits > 0 && !confirm(`Ø§ÛŒÙ† Ø¯Ø³ØªÙ‡ ${toFarsi(linkedHabits)} Ø¹Ø§Ø¯Øª Ø¯Ø§Ø±Ø¯. Ø­Ø°Ù Ø´ÙˆØ¯ØŸ`)) return; categories = categories.filter(c => c.id !== id); habits.forEach(h => { if (h.category === id) h.category = 'other'; }); save(); renderCategoryManager(); updateCategoriesUI(); renderList(); showToast('Ø¯Ø³ØªÙ‡ Ø­Ø°Ù Ø´Ø¯'); };
        }
    </script>
</body>
</html>
