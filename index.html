<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù‡Ø¨ÛŒØª ØªØ±Ú©Ø±</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#4f46e5">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/4305/4305432.png">
    
    <!-- Vazirmatn Font -->
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100..900&display=swap" rel="stylesheet">
    
    <style>
        /* --- VARIABLES --- */
        :root {
            --primary: #4f46e5; --primary-light: #818cf8; --primary-bg: #e0e7ff;
            --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
            --bg-body: #f8fafc; --bg-surface: #ffffff; --bg-input: #f1f5f9;
            --text-main: #0f172a; --text-muted: #64748b; --border: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --radius-l: 24px; --radius-m: 16px; --radius-s: 12px;
        }

        [data-theme="dark"] {
            --bg-body: #0f172a; --bg-surface: #1e293b; --bg-input: #334155;
            --text-main: #f8fafc; --text-muted: #94a3b8; --border: #334155; --primary-bg: #312e81;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; font-family: 'Vazirmatn', sans-serif; }
        body { font-family: 'Vazirmatn', sans-serif; background: var(--bg-body); color: var(--text-main); min-height: 100vh; line-height: 1.6; padding-bottom: 100px; -webkit-font-smoothing: antialiased; }

        .app-container { max-width: 500px; margin: 0 auto; padding: 16px; display: none; }
        .app-container.visible { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* AUTH SCREEN */
        .auth-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-body); z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 24px; text-align: center; }
        .auth-logo { width: 80px; height: 80px; background: var(--primary); border-radius: 20px; display: flex; align-items: center; justify-content: center; color: white; margin-bottom: 24px; box-shadow: 0 10px 25px rgba(79, 70, 229, 0.3); }
        .auth-card { background: var(--bg-surface); padding: 30px; border-radius: 24px; width: 100%; max-width: 400px; border: 1px solid var(--border); box-shadow: var(--shadow-md); }
        .auth-tabs { display: flex; margin-bottom: 20px; background: var(--bg-input); padding: 4px; border-radius: 12px; }
        .auth-tab { flex: 1; padding: 10px; border-radius: 10px; border: none; background: transparent; color: var(--text-muted); cursor: pointer; font-weight: 700; transition: all 0.2s; }
        .auth-tab.active { background: var(--bg-surface); color: var(--primary); box-shadow: var(--shadow-sm); }

        /* HEADER & UI */
        .header { margin-bottom: 20px; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .header h1 { font-size: 1.4rem; font-weight: 800; color: var(--text-main); letter-spacing: -0.5px; }
        .header-actions { display: flex; gap: 8px; }
        .icon-btn { background: var(--bg-surface); border: 1px solid var(--border); color: var(--text-muted); width: 38px; height: 38px; border-radius: var(--radius-s); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; transition: all 0.2s; position: relative; }
        .sync-badge { position: absolute; top: -2px; right: -2px; width: 10px; height: 10px; background: var(--warning); border-radius: 50%; border: 2px solid var(--bg-surface); display: none; }
        .icon-btn.unsynced .sync-badge { display: block; }
        .icon-btn.loading svg { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* LEVEL */
        .level-container { background: var(--bg-surface); padding: 12px 16px; border-radius: var(--radius-m); border: 1px solid var(--border); display: flex; align-items: center; gap: 14px; margin-bottom: 20px; }
        .level-badge { background: var(--primary); color: white; width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 1.1rem; flex-shrink: 0; box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3); }
        .level-info { flex: 1; }
        .level-text { display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 6px; font-weight: 600; color: var(--text-muted); }
        .xp-bar { height: 6px; background: var(--bg-body); border-radius: 10px; overflow: hidden; }
        .xp-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.6s ease; border-radius: 10px; }

        /* CALENDAR */
        .calendar-widget { background: var(--bg-surface); border-radius: var(--radius-l); box-shadow: var(--shadow-md); margin-bottom: 24px; overflow: hidden; border: 1px solid var(--border); }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; padding: 16px; background: var(--bg-surface); }
        .cal-title { font-weight: 800; font-size: 1rem; color: var(--text-main); }
        .cal-nav-btn { background: transparent; border: none; width: 32px; height: 32px; border-radius: 8px; color: var(--text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .calendar-grid-wrapper { transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1); max-height: 400px; overflow: hidden; padding: 0 8px 8px 8px; }
        .calendar-grid-wrapper.collapsed { max-height: 100px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); row-gap: 4px; column-gap: 2px; }
        .day-header { text-align: center; font-size: 0.7rem; color: var(--text-muted); padding: 8px 0; font-weight: 500; opacity: 0.7; }
        .cal-day { aspect-ratio: 1/0.9; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 10px; cursor: pointer; position: relative; transition: all 0.2s; font-size: 0.95rem; font-weight: 600; color: var(--text-main); border: 2px solid transparent; }
        .cal-day.today { color: var(--primary); border-color: var(--primary-light); }
        .cal-day.selected { background: var(--primary); color: white !important; border-color: var(--primary); box-shadow: 0 4px 12px rgba(79, 70, 229, 0.25); }
        .cal-dot { width: 4px; height: 4px; background: var(--success); border-radius: 50%; position: absolute; bottom: 4px; }
        .cal-day.selected .cal-dot { background: white; opacity: 0.9; }
        .calendar-toggle { display: flex; justify-content: center; padding: 6px; cursor: pointer; color: var(--text-muted); background: transparent; border-top: 1px solid var(--border); }
        .calendar-toggle.collapsed svg { transform: rotate(0deg); } .calendar-toggle svg { width: 18px; height: 18px; transition: transform 0.3s; transform: rotate(180deg); }

        /* FILTERS & LIST */
        .categories-filter { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 4px; margin-bottom: 20px; scrollbar-width: none; }
        .cat-btn { padding: 8px 14px; border-radius: 12px; border: 1px solid var(--border); background: var(--bg-surface); color: var(--text-muted); font-size: 0.8rem; white-space: nowrap; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px; font-weight: 600; }
        .cat-dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; }
        .cat-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .cat-btn.active .cat-dot { background: white; }
        
        .list-header { margin-bottom: 12px; color: var(--text-muted); font-size: 0.85rem; font-weight: 700; display: flex; justify-content: space-between; align-items: center; }
        .habits-list { display: flex; flex-direction: column; gap: 12px; }
        .habit-card { background: var(--bg-surface); border-radius: var(--radius-m); padding: 16px; border: 1px solid var(--border); box-shadow: var(--shadow-sm); display: flex; flex-direction: column; gap: 12px; position: relative; overflow: hidden; }
        .habit-card::before { content: ''; position: absolute; right: 0; top: 0; bottom: 0; width: 4px; background: var(--card-color); }
        .habit-header { display: flex; align-items: center; gap: 14px; }
        .habit-icon-box { width: 48px; height: 48px; border-radius: 14px; display: flex; align-items: center; justify-content: center; background: var(--bg-input); flex-shrink: 0; color: var(--text-main); }
        .habit-icon-box svg { width: 24px; height: 24px; stroke-width: 1.5; }
        .habit-info { flex: 1; min-width: 0; }
        .habit-title { font-weight: 700; font-size: 1rem; margin-bottom: 4px; color: var(--text-main); }
        .habit-meta { font-size: 0.75rem; color: var(--text-muted); display: flex; gap: 8px; align-items: center; }
        .habit-badge { background: var(--bg-input); padding: 2px 6px; border-radius: 6px; font-weight: 500; color: var(--text-muted); }
        .habit-actions { display: flex; justify-content: space-between; align-items: center; padding-top: 12px; border-top: 1px solid var(--border); }
        .action-group { display: flex; gap: 8px; }
        .mini-btn { width: 34px; height: 34px; border-radius: 10px; border: none; background: transparent; color: var(--text-muted); display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .check-btn { width: 42px; height: 42px; border-radius: 12px; border: 2px solid var(--border); background: transparent; color: var(--border); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; }
        .check-btn.checked { background: var(--success); border-color: var(--success); color: white; }
        .play-btn { border-color: var(--primary); color: var(--primary); }
        .check-btn svg { width: 22px; height: 22px; stroke-width: 3; opacity: 0; transform: scale(0.5); transition: all 0.2s; }
        .check-btn.checked svg, .play-btn svg { opacity: 1; transform: scale(1); fill: currentColor; }

        /* COMMON MODAL & FORM */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: flex-end; opacity: 0; transition: opacity 0.3s; }
        .modal.active { display: flex; opacity: 1; }
        .modal-content { background: var(--bg-surface); width: 100%; max-width: 500px; border-radius: 24px 24px 0 0; padding: 24px; max-height: 85vh; overflow-y: auto; transform: translateY(100%); transition: transform 0.3s; margin: 0 auto; }
        @media (min-width: 600px) { .modal { align-items: center; } .modal-content { border-radius: 24px; transform: scale(0.95); } .modal.active .modal-content { transform: scale(1); } }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; color: var(--text-muted); font-weight: 600; font-size: 0.9rem; }
        .form-input, .form-select, textarea.form-input { width: 100%; padding: 14px; border: 2px solid var(--border); border-radius: 14px; background: var(--bg-input); color: var(--text-main); font-size: 1rem; font-family: inherit; }
        
        .fab { position: fixed; bottom: 30px; left: 24px; width: 56px; height: 56px; border-radius: 18px; background: var(--primary); color: white; border: none; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3); z-index: 100; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .fab svg { width: 28px; height: 28px; stroke-width: 2.5; }

        .timer-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-body); z-index: 3000; display: flex; flex-direction: column; align-items: center; justify-content: center; transform: translateY(100%); transition: transform 0.4s; }
        .timer-overlay.active { transform: translateY(0); }
        .timer-circle { width: 240px; height: 240px; border-radius: 50%; border: 6px solid var(--bg-card); display: flex; align-items: center; justify-content: center; margin-bottom: 40px; }
        .timer-time { font-size: 4rem; font-weight: 900; }
        .timer-btns { display: flex; gap: 24px; }
        .big-btn { width: 64px; height: 64px; border-radius: 20px; border: none; font-size: 2rem; color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: var(--bg-surface); padding: 10px 20px; border-radius: 20px; box-shadow: var(--shadow-md); border: 1px solid var(--border); z-index: 4000; opacity: 0; transition: all 0.4s; font-weight: 600; white-space: nowrap; display: flex; align-items: center; gap: 8px; }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

        /* Selectors */
        .days-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .day-checkbox { display: none; }
        .day-label { background: var(--bg-input); padding: 12px; border-radius: 12px; text-align: center; cursor: pointer; border: 2px solid transparent; color: var(--text-muted); }
        .day-checkbox:checked + .day-label { background: var(--primary-bg); border-color: var(--primary); color: var(--primary); font-weight: 700; }
        .icon-grid { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 8px; }
        .icon-opt { width: 50px; height: 50px; flex-shrink: 0; background: var(--bg-input); border-radius: 14px; display: flex; align-items: center; justify-content: center; border: 2px solid transparent; cursor: pointer; color: var(--text-muted); }
        .icon-opt svg { width: 24px; height: 24px; }
        .icon-opt.selected { border-color: var(--primary); background: var(--primary-bg); color: var(--primary); }
        .color-grid { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;}
        .color-opt { width: 40px; height: 40px; border-radius: 50%; border: 3px solid transparent; cursor: pointer; }
        .color-opt.selected { transform: scale(1.15); box-shadow: 0 0 0 2px var(--text-main); }
        .cat-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px; }
        .cat-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 14px; background: var(--bg-input); border-radius: 12px; }
        .btn-delete-cat { color: var(--danger); background: rgba(239, 68, 68, 0.1); border: none; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        /* Analytics */
        .chart-container { margin-bottom: 24px; text-align: center; }
        .heatmap-grid { display: grid; grid-template-columns: repeat(20, 1fr); gap: 3px; margin-top: 10px; justify-content: center; }
        .heatmap-cell { aspect-ratio: 1; border-radius: 3px; background: var(--bg-input); }
    </style>
</head>
<body>
    <!-- AUTH -->
    <div class="auth-screen" id="authScreen">
        <div class="auth-logo"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg></div>
        <h2 style="margin-bottom: 8px;">Ø¨Ù‡ Ù‡Ø¨ÛŒØª ØªØ±Ú©Ø± Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯</h2>
        <p style="color:var(--text-muted); margin-bottom:24px;">Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø§Ø¦Ù…ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯</p>
        <div class="auth-card">
            <div class="auth-tabs">
                <button class="auth-tab active" id="tabLogin">ÙˆØ±ÙˆØ¯</button>
                <button class="auth-tab" id="tabRegister">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</button>
            </div>
            <form id="authForm">
                <div class="form-group"><input type="text" id="authUsername" class="form-input" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ" required style="text-align:left;"></div>
                <div class="form-group"><input type="password" id="authPassword" class="form-input" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±" required style="text-align:left;"></div>
                <button type="submit" class="form-input" id="btnAuthSubmit" style="background: var(--primary); color: white; font-weight: bold; border: none; margin-bottom: 12px;">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø­Ø³Ø§Ø¨</button>
                <button type="button" id="btnGuest" style="background: transparent; border: none; color: var(--text-muted); font-size: 0.9rem; cursor: pointer;">Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù…Ù‡Ù…Ø§Ù† (Ø¢ÙÙ„Ø§ÛŒÙ†)</button>
            </form>
        </div>
    </div>

    <!-- MAIN APP -->
    <div class="app-container" id="appContainer">
        <header class="header">
            <div class="header-top">
                <h1>Ù‡Ø¨ÛŒØª ØªØ±Ú©Ø±</h1>
                <div class="header-actions">
                    <button class="icon-btn" id="btnSync"><div class="sync-badge" id="syncBadge"></div><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></svg></button>
                    <button class="icon-btn" id="btnAnalytics"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg></button>
                    <button class="icon-btn" id="btnSettings"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></button>
                </div>
            </div>
            <div class="level-container">
                <div class="level-badge" id="userLevel">1</div>
                <div class="level-info"><div class="level-text"><span id="levelTitle">Ú©Ø§Ø±Ø¨Ø± ØªØ§Ø²Ù‡â€ŒÚ©Ø§Ø±</span><span id="xpText">0 XP</span></div><div class="xp-bar"><div class="xp-fill" id="xpFill"></div></div></div>
            </div>
        </header>

        <div class="categories-filter" id="catFilters"></div>
        <div class="calendar-widget">
            <div class="calendar-header">
                <button class="cal-nav-btn" id="prevMonth"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M15 18l-6-6 6-6"/></svg></button>
                <div class="cal-title" id="calTitle">...</div>
                <button class="cal-nav-btn" id="nextMonth"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M9 18l6-6-6-6"/></svg></button>
            </div>
            <div class="calendar-grid-wrapper collapsed" id="calWrapper"><div class="calendar-grid" id="calendarGrid"></div></div>
            <div class="calendar-toggle collapsed" id="calToggle"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M6 9l6 6 6-6"/></svg></div>
        </div>
        <div class="list-header"><span id="dateTitle">Ø§Ù…Ø±ÙˆØ²</span><span id="activeCount">0 Ø¹Ø§Ø¯Øª</span></div>
        <div class="habits-list" id="habitsList"></div>
    </div>

    <button class="fab" id="btnAddHabit"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg></button>

    <!-- MODALS -->
    <div class="modal" id="habitModal">
        <div class="modal-content">
            <h3 style="margin-bottom: 24px; text-align: center;">ØªØ¹Ø±ÛŒÙ Ø¹Ø§Ø¯Øª</h3>
            <form id="habitForm">
                <div class="form-group"><label class="form-label">Ø¹Ù†ÙˆØ§Ù†</label><input type="text" class="form-input" id="habitName" required></div>
                <div class="form-group"><label class="form-label">Ø¯Ø³ØªÙ‡</label><select class="form-select" id="habitCategory"></select></div>
                <div class="form-group"><label class="form-label">ØªÚ©Ø±Ø§Ø±</label><select class="form-select" id="habitFrequency"><option value="daily">Ù‡Ø± Ø±ÙˆØ²</option><option value="weekly">Ù‡ÙØªÚ¯ÛŒ (Ø¬Ù…Ø¹Ù‡)</option><option value="custom">Ø±ÙˆØ²Ù‡Ø§ÛŒ Ø®Ø§Øµ</option></select></div>
                <div class="form-group" id="customDaysGroup" style="display:none"><div class="days-grid"><label><input type="checkbox" class="day-checkbox" value="0"><div class="day-label">Ø´</div></label><label><input type="checkbox" class="day-checkbox" value="1"><div class="day-label">Û±Ø´</div></label><label><input type="checkbox" class="day-checkbox" value="2"><div class="day-label">Û²Ø´</div></label><label><input type="checkbox" class="day-checkbox" value="3"><div class="day-label">Û³Ø´</div></label><label><input type="checkbox" class="day-checkbox" value="4"><div class="day-label">Û´Ø´</div></label><label><input type="checkbox" class="day-checkbox" value="5"><div class="day-label">ÛµØ´</div></label><label><input type="checkbox" class="day-checkbox" value="6"><div class="day-label">Ø¬</div></label></div></div>
                <div class="form-group"><label class="form-label">Ø¢ÛŒÚ©ÙˆÙ†</label><div class="icon-grid" id="iconSelector"></div></div>
                <div class="form-group"><label class="form-label">Ø±Ù†Ú¯</label><div class="color-grid" id="colorSelector"><div class="color-opt selected" data-color="#4f46e5" style="background:#4f46e5"></div><div class="color-opt" data-color="#10b981" style="background:#10b981"></div><div class="color-opt" data-color="#f59e0b" style="background:#f59e0b"></div><div class="color-opt" data-color="#ef4444" style="background:#ef4444"></div><div class="color-opt" data-color="#ec4899" style="background:#ec4899"></div><div class="color-opt" data-color="#06b6d4" style="background:#06b6d4"></div></div></div>
                <div class="form-group" style="background:var(--bg-input);padding:12px;border-radius:12px"><label style="display:flex;align-items:center;gap:12px;cursor:pointer"><input type="checkbox" id="habitTimer" style="width:20px;height:20px"><span style="font-weight:600">ØªØ§ÛŒÙ…Ø±</span></label><div id="timerSettings" style="display:none;margin-top:12px"><label class="form-label">Ø¯Ù‚ÛŒÙ‚Ù‡:</label><input type="number" id="timerDuration" class="form-input" value="25"></div></div>
                <div style="display:flex;gap:10px;margin-top:30px"><button type="button" class="form-input" id="btnCloseModal">Ù„ØºÙˆ</button><button type="submit" class="form-input" style="background:var(--primary);color:white">Ø°Ø®ÛŒØ±Ù‡</button></div>
            </form>
        </div>
    </div>

    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <h3 style="margin-bottom:20px">ØªÙ†Ø¸ÛŒÙ…Ø§Øª</h3>
            <div style="background:var(--bg-input);padding:16px;border-radius:12px;margin-bottom:16px;display:flex;justify-content:space-between;align-items:center"><span>ğŸ‘¤ <span id="settingsUser">Ù…Ù‡Ù…Ø§Ù†</span></span><button id="btnLogout" style="color:var(--danger);border:none;background:none;font-weight:bold;cursor:pointer">Ø®Ø±ÙˆØ¬</button></div>
            <button class="form-input" id="btnReqNotify" style="margin-bottom:12px;background:var(--bg-input)">ğŸ”” ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø§Ø¹Ù„Ø§Ù†</button>
            <button class="form-input" id="btnManageCats" style="margin-bottom:12px;background:var(--bg-input)">ğŸ“‚ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§</button>
            <button class="form-input" id="btnTheme" style="margin-bottom:12px;background:var(--bg-input)">ğŸŒ“ ØªØºÛŒÛŒØ± Ù¾ÙˆØ³ØªÙ‡</button>
            <button class="form-input" id="btnReset" style="background:rgba(239,68,68,0.1);color:var(--danger);border:none">âš ï¸ Ø­Ø°Ù Ù‡Ù…Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª</button>
            <button class="form-input" id="btnCloseSettings" style="margin-top:20px;border:none;background:var(--bg-input)">Ø¨Ø³ØªÙ†</button>
        </div>
    </div>

    <div class="modal" id="categoryModal"><div class="modal-content"><h3>Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§</h3><div class="cat-list" id="categoryList"></div><div class="add-cat-form" style="display:flex;gap:10px;margin-top:20px;border-top:1px solid var(--border);padding-top:20px"><input type="text" id="newCatName" class="form-input" placeholder="Ù†Ø§Ù…"><input type="color" id="newCatColor" value="#4f46e5" style="width:50px;height:50px;border:none;background:none"><button class="icon-btn" id="btnAddCategory" style="background:var(--success);color:white">OK</button></div><button class="form-input" id="btnCloseCatManager" style="margin-top:20px">Ø¨Ø§Ø²Ú¯Ø´Øª</button></div></div>
    <div class="modal" id="timerCompleteModal" style="z-index:3500"><div class="modal-content" style="text-align:center"><div style="font-size:4rem">ğŸ‰</div><h3>Ø²Ù…Ø§Ù† ØªÙ…Ø§Ù… Ø´Ø¯!</h3><button class="form-input" id="btnConfirmTimer" style="background:var(--primary);color:white;margin-bottom:10px">Ø«Ø¨Øª Ø¹Ø§Ø¯Øª</button><button class="form-input" id="btnCancelTimerFinish">ÙÙ‚Ø· Ø¨Ø¨Ù†Ø¯</button></div></div>
    <div class="modal" id="analyticsModal"><div class="modal-content"><div style="display:flex;justify-content:space-between"><h3>Ø¢Ù…Ø§Ø±</h3><button class="icon-btn" id="btnCloseAnalytics">âœ•</button></div><div class="chart-container"><h4>Ù…ÙˆÙÙ‚ÛŒØª (Û· Ø±ÙˆØ²)</h4><div id="successRateText" style="font-size:2.5rem;font-weight:900;color:var(--primary)">0%</div></div><div class="chart-container"><h4>ÙØ¹Ø§Ù„ÛŒØª Ø³Ø§Ù„Ø§Ù†Ù‡</h4><div class="heatmap-grid" id="heatmapGrid"></div></div></div></div>
    <div class="modal" id="noteModal"><div class="modal-content"><h3>ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</h3><p id="noteDateDisplay" style="color:var(--text-muted);margin-bottom:10px"></p><textarea id="noteInput" class="form-input" rows="5"></textarea><div style="display:flex;gap:10px;margin-top:10px"><button class="form-input" id="btnCloseNote">Ø¨Ø³ØªÙ†</button><button class="form-input" id="btnSaveNote" style="background:var(--primary);color:white">Ø°Ø®ÛŒØ±Ù‡</button></div></div></div>
    <div class="modal" id="confirmModal" style="z-index:4000"><div class="modal-content" style="text-align:center"><div style="font-size:3rem">âš ï¸</div><h3 id="confirmTitle">ØŸ</h3><p id="confirmMessage" style="color:var(--text-muted)"></p><button class="form-input" id="btnConfirmYes" style="background:var(--danger);color:white;margin-bottom:10px">Ø¨Ù„Ù‡</button><button class="form-input" id="btnConfirmNo">Ø®ÛŒØ±</button></div></div>

    <div class="timer-overlay" id="timerOverlay"><div class="timer-circle"><span class="timer-time" id="timerDisplay">25:00</span></div><h2 id="timerHabitTitle">...</h2><div class="timer-btns"><button class="big-btn" id="btnStopTimer" style="background:var(--danger)">â– </button><button class="big-btn" id="btnToggleTimer" style="background:var(--primary)">â–¶</button></div><button id="btnExitTimer" style="margin-top:40px;background:none;border:none;color:var(--text-muted)">Ø®Ø±ÙˆØ¬</button></div>
    <div class="toast" id="toast"><span>Ù¾ÛŒØ§Ù…</span></div>

    <script>
        // *** CONFIG ***
        // Ø¢Ø¯Ø±Ø³ ÙˆØ±Ú©Ø± Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:
        const CLOUDFLARE_WORKER_URL = "https://habit.mikasaa.workers.dev/"; 

        // ICONS & DATA
        const ICONS = {
            target: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>`,
            book: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>`,
            gym: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M6 7h12M6 17h12M4 5v14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2z"/></svg>`,
            water: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg>`,
            sleep: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>`,
            code: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>`,
            sun: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>`,
            heart: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>`,
            music: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>`,
            pen: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/><circle cx="11" cy="11" r="2"/></svg>`
        };
        
        const farsiDigits = ['Û°','Û±','Û²','Û³','Û´','Ûµ','Û¶','Û·','Û¸','Û¹'];
        const toFarsi = n => n.toString().replace(/\d/g, x => farsiDigits[x]);
        const getTodayDate = () => new Date().toISOString().split('T')[0];
        
        // Jalaali Lib (Minified)
        function toJalaali(g,m,d){var a=[0,31,59,90,120,151,181,212,243,273,304,334],b=m>2?g+1:g,c=355666+365*g+~~((b+3)/4)-~~((b+99)/100)+~~((b+399)/400)+d+a[m-1],e=-1595+33*~~(c/12053);c%=12053;e+=4*~~(c/1461);c%=1461;if(c>365){e+=~~((c-1)/365);c=(c-1)%365}var f,h;if(c<186){f=1+~~(c/31);h=1+c%31}else{f=7+~~((c-186)/30);h=1+(c-186)%30}return{jy:e,jm:f,jd:h}}
        function toGregorian(j,m,d){var a=j+1595,b=-355668+365*a+~~(a/33)*8+~~((a%33+3)/4)+d+((m<7)?(m-1)*31:((m-7)*30)+186),g=400*~~(b/146097);b%=146097;if(b>36524){g+=100*~~(--b/36524);b%=36524;if(b>=365)b++}g+=4*~~(b/1461);b%=1461;if(b>365){g+=~~((b-1)/365);b=(b-1)%365}var h=b+1,k=[0,31,28,31,30,31,30,31,31,30,31,30,31];if((g%4===0&&g%100!==0)||(g%400===0))k[2]=29;var i;for(i=0;i<13;i++){if(h<=k[i])break;h-=k[i]}return{gy:g,gm:i,gd:h}}
        function jalaaliMonthLength(y,m){if(m<=6)return 31;if(m<=11)return 30;var r=y%33;var l=[1,5,9,13,17,22,26,30].includes(r);return l?30:29;}

        // STATE
        let habits=[], userStats={xp:0,level:1}, categories=[];
        let authState={token:null, user:'guest'};
        let editId=null, selectedDate=getTodayDate(), activeFilter='all';
        let timerInterval=null, timeLeft=0, isTimerRunning=false, activeTimerHabitId=null;
        let currentNoteId=null, isCalExpanded=false, viewJYear, viewJMonth, pendingConfirmAction=null;
        let isAuthModeLogin=true;

        // DOM Elements
        const el=id=>document.getElementById(id);
        const els={
            list:el('habitsList'), modal:el('habitModal'), settings:el('settingsModal'),
            analytics:el('analyticsModal'), note:el('noteModal'), timer:el('timerOverlay'),
            toast:el('toast'), form:el('habitForm'), calGrid:el('calendarGrid'), calTitle:el('calTitle'),
            auth:el('authScreen'), app:el('appContainer'), timerComplete:el('timerCompleteModal'), confirm:el('confirmModal')
        };

        document.addEventListener('DOMContentLoaded', () => {
            initApp();
        });

        function initApp() {
            // 1. Load data from localStorage first
            loadLocalData();
            
            // 2. Check Auth state
            checkAuth();
            
            // 3. Init Date
            const now = new Date();
            const j = toJalaali(now.getFullYear(), now.getMonth()+1, now.getDate());
            viewJYear = j.jy; viewJMonth = j.jm;
            
            // 4. Init Theme
            document.documentElement.setAttribute('data-theme', localStorage.getItem('theme') || 'light');
            
            // 5. Render UI
            renderIcons();
            updateCategoriesUI();
            renderCalendar();
            renderList();
            updateStats();
            setupEvents();
        }

        function loadLocalData() {
            try {
                habits = JSON.parse(localStorage.getItem('habits_ultimate')) || [];
                userStats = JSON.parse(localStorage.getItem('user_stats_ultimate')) || {xp:0,level:1};
                categories = JSON.parse(localStorage.getItem('habit_categories')) || [
                    {id:'health',name:'Ø³Ù„Ø§Ù…ØªÛŒ',color:'#10b981'}, {id:'learn',name:'ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ',color:'#4f46e5'}, {id:'work',name:'Ú©Ø§Ø±',color:'#f59e0b'}
                ];
                
                // CRITICAL: Retrieve Auth Token
                const t = localStorage.getItem('auth_token');
                const u = localStorage.getItem('auth_user');
                if(t && u) authState = { token: t, user: u };
                
            } catch(e) { console.error('Load Error', e); }
        }

        function checkAuth() {
            const isGuest = localStorage.getItem('guest_mode') === 'true';
            
            if (authState.token || isGuest) {
                els.auth.style.display = 'none';
                els.app.classList.add('visible');
                el('settingsUser').textContent = authState.user;
                if(authState.token) syncData('pull');
            } else {
                els.auth.style.display = 'flex';
                els.app.classList.remove('visible');
            }
        }

        async function handleAuth(e) {
            e.preventDefault();
            const btn = el('btnAuthSubmit');
            const origText = btn.textContent;
            btn.textContent = 'Ù„Ø·ÙØ§ ØµØ¨Ø± Ú©Ù†ÛŒØ¯...';
            btn.disabled = true;

            const u = el('authUsername').value;
            const p = el('authPassword').value;
            const endpoint = isAuthModeLogin ? '/login' : '/register';

            if(CLOUDFLARE_WORKER_URL.includes("your-worker-url")) {
                showToast("Ù„Ø·ÙØ§ Ø¢Ø¯Ø±Ø³ ÙˆØ±Ú©Ø± Ø±Ø§ Ø¯Ø± Ú©Ø¯ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯", "error");
                btn.textContent = origText; btn.disabled = false;
                return;
            }

            try {
                const res = await fetch(`${CLOUDFLARE_WORKER_URL}${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: u, password: p })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    authState = { token: data.token, user: u };
                    localStorage.setItem('auth_token', data.token);
                    localStorage.setItem('auth_user', u);
                    localStorage.removeItem('guest_mode');
                    checkAuth();
                    showToast(isAuthModeLogin ? 'Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯' : 'Ø­Ø³Ø§Ø¨ Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯');
                } else {
                    showToast(data.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø¹Ù…Ù„ÛŒØ§Øª', 'error');
                }
            } catch (err) {
                console.error(err);
                showToast("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±", "error");
            } finally {
                btn.textContent = origText;
                btn.disabled = false;
            }
        }

        async function syncData(direction = 'push') {
            if (!authState.token) return;
            const btn = el('btnSync');
            btn.classList.add('loading');

            try {
                const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authState.token}` };
                
                if (direction === 'push') {
                    await fetch(`${CLOUDFLARE_WORKER_URL}/data`, {
                        method: 'POST', headers,
                        body: JSON.stringify({ habits, userStats, categories, timestamp: Date.now() })
                    });
                    el('syncBadge').style.display = 'none';
                    showToast('Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
                } else {
                    const res = await fetch(`${CLOUDFLARE_WORKER_URL}/data`, { headers });
                    if(res.ok) {
                        const data = await res.json();
                        if (data && data.habits) {
                            habits = data.habits; userStats = data.userStats; categories = data.categories || categories;
                            save(false); renderList(); renderCalendar(); updateStats();
                        }
                    }
                }
            } catch (err) {
                console.error("Sync Error", err);
                el('btnSync').classList.add('unsynced');
                showToast("Ø®Ø·Ø§ Ø¯Ø± Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ", "error");
            } finally {
                btn.classList.remove('loading');
            }
        }

        // --- CORE FUNCTIONS (Simpler version) ---
        function save(triggerSync = true) { 
            localStorage.setItem('habits_ultimate', JSON.stringify(habits));
            localStorage.setItem('habit_categories', JSON.stringify(categories));
            localStorage.setItem('user_stats_ultimate', JSON.stringify(userStats));
            if(triggerSync && authState.token) {
                el('btnSync').classList.add('unsynced');
                // Debounce sync could go here, but manual sync button is fine for now
            }
        }

        // --- RENDERERS ---
        function renderIcons(){const c=el('iconSelector');c.innerHTML='';Object.keys(ICONS).forEach((k,i)=>{const d=document.createElement('div');d.className=`icon-opt ${i===0?'selected':''}`;d.dataset.icon=k;d.innerHTML=ICONS[k];d.onclick=function(){document.querySelectorAll('.icon-opt').forEach(x=>x.classList.remove('selected'));this.classList.add('selected');};c.appendChild(d)})}
        function updateCategoriesUI(){const f=el('catFilters');f.innerHTML='';const all=document.createElement('button');all.className=`cat-btn ${activeFilter==='all'?'active':''}`;all.innerHTML='Ù‡Ù…Ù‡';all.onclick=()=>{activeFilter='all';updateCategoriesUI();renderList()};f.appendChild(all);categories.forEach(c=>{const b=document.createElement('button');b.className=`cat-btn ${activeFilter===c.id?'active':''}`;b.innerHTML=`<div class="cat-dot" style="color:${c.color}"></div>${c.name}`;b.onclick=()=>{activeFilter=c.id;updateCategoriesUI();renderList()};f.appendChild(b)});const s=el('habitCategory');s.innerHTML=categories.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');if(!categories.length)s.innerHTML='<option value="other">Ø³Ø§ÛŒØ±</option>'}
        function renderCalendar(){const mNames=['ÙØ±ÙˆØ±Ø¯ÛŒÙ†','Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª','Ø®Ø±Ø¯Ø§Ø¯','ØªÛŒØ±','Ù…Ø±Ø¯Ø§Ø¯','Ø´Ù‡Ø±ÛŒÙˆØ±','Ù…Ù‡Ø±','Ø¢Ø¨Ø§Ù†','Ø¢Ø°Ø±','Ø¯ÛŒ','Ø¨Ù‡Ù…Ù†','Ø§Ø³ÙÙ†Ø¯'];els.calTitle.textContent=`${mNames[viewJMonth-1]} ${toFarsi(viewJYear)}`;els.calGrid.innerHTML='';['Ø´','ÛŒ','Ø¯','Ø³','Ú†','Ù¾','Ø¬'].forEach(t=>{const d=document.createElement('div');d.className='day-header';d.textContent=t;els.calGrid.appendChild(d)});const g=toGregorian(viewJYear,viewJMonth,1);const start=(new Date(g.gy,g.gm-1,g.gd).getDay()+1)%7;const len=jalaaliMonthLength(viewJYear,viewJMonth);for(let i=0;i<start;i++)els.calGrid.appendChild(document.createElement('div'));for(let d=1;d<=len;d++){const gd=toGregorian(viewJYear,viewJMonth,d);const iso=`${gd.gy}-${String(gd.gm).padStart(2,'0')}-${String(gd.gd).padStart(2,'0')}`;const cell=document.createElement('div');const hasAct=habits.some(h=>h.completedDates?.includes(iso));cell.className=`cal-day ${iso===getTodayDate()?'today':''} ${iso===selectedDate?'selected':''}`;cell.innerHTML=`<span>${toFarsi(d)}</span>${hasAct?'<div class="cal-dot"></div>':''}`;cell.onclick=()=>{selectedDate=iso;renderCalendar();renderList()};els.calGrid.appendChild(cell)}}
        function renderList(){els.list.innerHTML='';const parts=selectedDate.split('-').map(Number);const j=toJalaali(parts[0],parts[1],parts[2]);const mNames=['ÙØ±ÙˆØ±Ø¯ÛŒÙ†','Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª','Ø®Ø±Ø¯Ø§Ø¯','ØªÛŒØ±','Ù…Ø±Ø¯Ø§Ø¯','Ø´Ù‡Ø±ÛŒÙˆØ±','Ù…Ù‡Ø±','Ø¢Ø¨Ø§Ù†','Ø¢Ø°Ø±','Ø¯ÛŒ','Ø¨Ù‡Ù…Ù†','Ø§Ø³ÙÙ†Ø¯'];el('dateTitle').textContent=`${toFarsi(j.jd)} ${mNames[j.jm-1]} ${toFarsi(j.jy)}`;const pDay=(new Date(selectedDate).getDay()+1)%7;const active=habits.filter(h=>{if(activeFilter!=='all'&&h.category!==activeFilter)return false;if(h.frequency==='daily')return true;if(h.frequency==='weekly')return pDay===6;return h.customDays?.includes(pDay)});el('activeCount').textContent=`${toFarsi(active.length)} Ø¹Ø§Ø¯Øª`;if(!active.length){els.list.innerHTML='<div style="text-align:center;padding:40px;opacity:0.6"><div style="font-size:3rem">â˜•</div><p>Ø®Ø§Ù„ÛŒ</p></div>';return}active.forEach(h=>{const isDone=h.completedDates?.includes(selectedDate);const cat=categories.find(c=>c.id===h.category);const card=document.createElement('div');card.className='habit-card';card.innerHTML=`<div class="habit-header"><div class="habit-icon-box" style="color:${h.color};background:${h.color}15">${ICONS[h.icon]||ICONS.target}</div><div class="habit-info"><div class="habit-title" style="${isDone?'text-decoration:line-through;opacity:0.5':''}">${h.name}</div><div class="habit-meta"><span class="habit-badge" style="color:${cat?cat.color:'#999'}">${cat?cat.name:'Ø³Ø§ÛŒØ±'}</span></div></div></div><div class="habit-actions"><div class="action-group"><button class="mini-btn" onclick="editHabit('${h.id}')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button><button class="mini-btn" onclick="openNote('${h.id}')" style="${h.notes?.[selectedDate]?'color:var(--primary)':''}"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg></button><button class="mini-btn" onclick="deleteHabit('${h.id}')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button></div>${h.hasTimer&&!isDone?`<button class="check-btn play-btn" onclick="startTimer('${h.id}')"><svg viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></button>`:`<button class="check-btn ${isDone?'checked':''}" onclick="toggleHabit('${h.id}')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="20 6 9 17 4 12"></polyline></svg></button>`}</div>`;els.list.appendChild(card)})}

        // EVENTS
        function setupEvents(){
            el('tabLogin').onclick=()=>{isAuthModeLogin=true;el('tabLogin').classList.add('active');el('tabRegister').classList.remove('active');el('btnAuthSubmit').textContent='ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø­Ø³Ø§Ø¨'};
            el('tabRegister').onclick=()=>{isAuthModeLogin=false;el('tabRegister').classList.add('active');el('tabLogin').classList.remove('active');el('btnAuthSubmit').textContent='Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…'};
            el('authForm').onsubmit=handleAuth;
            el('btnGuest').onclick=()=>{localStorage.setItem('guest_mode','true');authState.user='Ù…Ù‡Ù…Ø§Ù†';checkAuth()};
            el('btnLogout').onclick=()=>{localStorage.removeItem('auth_token');localStorage.removeItem('auth_user');localStorage.removeItem('guest_mode');authState={token:null,user:'guest'};checkAuth();window.location.reload()};
            el('btnSync').onclick=()=>syncData('push');
            
            el('calToggle').onclick=()=>{isCalExpanded=!isCalExpanded;els.calGrid.parentElement.className=isCalExpanded?'calendar-grid-wrapper':'calendar-grid-wrapper collapsed';el('calToggle').classList.toggle('collapsed')};
            el('prevMonth').onclick=()=>{viewJMonth--;if(viewJMonth<1){viewJMonth=12;viewJYear--}renderCalendar()};
            el('nextMonth').onclick=()=>{viewJMonth++;if(viewJMonth>12){viewJMonth=1;viewJYear++}renderCalendar()};
            el('btnAddHabit').onclick=()=>{editId=null;els.form.reset();el('customDaysGroup').style.display='none';el('timerSettings').style.display='none';els.modal.classList.add('active')};
            el('btnCloseModal').onclick=()=>els.modal.classList.remove('active');
            el('habitFrequency').onchange=(e)=>el('customDaysGroup').style.display=e.target.value==='custom'?'block':'none';
            el('habitTimer').onchange=(e)=>el('timerSettings').style.display=e.target.checked?'block':'none';
            els.form.onsubmit=(e)=>{e.preventDefault();const n=el('habitName').value,f=el('habitFrequency').value,c=el('habitCategory').value,tm=el('habitTimer').checked,td=parseInt(el('timerDuration').value)||25,ic=document.querySelector('.icon-opt.selected').dataset.icon,cl=document.querySelector('.color-opt.selected').dataset.color;let cd=[];if(f==='custom')document.querySelectorAll('.day-checkbox:checked').forEach(x=>cd.push(parseInt(x.value)));const hObj={id:editId||Date.now().toString(),name:n,frequency:f,category:c,customDays:cd,icon:ic,color:cl,hasTimer:tm,timerDuration:td,completedDates:editId?habits.find(h=>h.id===editId).completedDates:[],notes:editId?habits.find(h=>h.id===editId).notes:{}};if(editId){const i=habits.findIndex(x=>x.id===editId);habits[i]=hObj}else habits.push(hObj);save();els.modal.classList.remove('active');renderList();renderCalendar()};
            
            el('btnToggleTimer').onclick=toggleTimer;
            el('btnStopTimer').onclick=()=>{showConfirm('ØªÙˆÙ‚ÙØŸ',stopTimerLogic,'Ù‡Ø´Ø¯Ø§Ø±',true)};
            el('btnExitTimer').onclick=()=>{showConfirm('Ø®Ø±ÙˆØ¬ØŸ',stopTimerLogic,'Ù‡Ø´Ø¯Ø§Ø±',true)};
            el('btnConfirmTimer').onclick=()=>{const h=habits.find(x=>x.id===activeTimerHabitId);if(h&&!h.completedDates.includes(selectedDate)){h.completedDates.push(selectedDate);addXP(20);save();renderList();showToast('Ø«Ø¨Øª Ø´Ø¯')}els.timerComplete.classList.remove('active');activeTimerHabitId=null};
            el('btnCancelTimerFinish').onclick=()=>{els.timerComplete.classList.remove('active');activeTimerHabitId=null};
            
            el('btnSettings').onclick=()=>els.settings.classList.add('active');
            el('btnCloseSettings').onclick=()=>els.settings.classList.remove('active');
            el('btnManageCats').onclick=()=>{renderCategoryManager();el('categoryModal').classList.add('active')};
            el('btnCloseCatManager').onclick=()=>el('categoryModal').classList.remove('active');
            el('btnAddCategory').onclick=()=>{const n=el('newCatName').value,c=el('newCatColor').value;if(n){categories.push({id:'cat_'+Date.now(),name:n,color:c});el('newCatName').value='';updateCategoriesUI();renderCategoryManager();save()}};
            el('btnReqNotify').onclick=requestNotificationPermission;
            el('btnTheme').onclick=()=>{const n=document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark';document.documentElement.setAttribute('data-theme',n);localStorage.setItem('theme',n)};
            
            el('btnAnalytics').onclick=showAnalytics; el('btnCloseAnalytics').onclick=()=>els.analytics.classList.remove('active');
            el('btnCloseNote').onclick=()=>els.note.classList.remove('active');
            el('btnSaveNote').onclick=()=>{const h=habits.find(x=>x.id===currentNoteId);if(!h.notes)h.notes={};const v=el('noteInput').value.trim();if(v)h.notes[selectedDate]=v;else delete h.notes[selectedDate];save();els.note.classList.remove('active');renderList()};
            
            el('btnConfirmYes').onclick=()=>{if(pendingConfirmAction)pendingConfirmAction();els.confirm.classList.remove('active');pendingConfirmAction=null};
            el('btnConfirmNo').onclick=()=>{els.confirm.classList.remove('active');pendingConfirmAction=null};
            el('btnReset').onclick=()=>showConfirm('Ø­Ø°Ù Ú©Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§ØªØŸ',()=>{habits=[];userStats={xp:0,level:1};save();renderList();renderCalendar();els.settings.classList.remove('active')},'Ù‡Ø´Ø¯Ø§Ø±',true);
        }

        // HELPERS
        function toggleHabit(id){const h=habits.find(x=>x.id===id);if(!h.completedDates)h.completedDates=[];const i=h.completedDates.indexOf(selectedDate);if(i>-1){h.completedDates.splice(i,1);addXP(-10)}else{h.completedDates.push(selectedDate);addXP(10)}save();renderList();renderCalendar()}
        function startTimer(id){activeTimerHabitId=id;el('timerHabitTitle').textContent=habits.find(x=>x.id===id).name;timeLeft=(habits.find(x=>x.id===id).timerDuration||25)*60;updateTimerDisplay();els.timer.classList.add('active');toggleTimer(true)}
        function toggleTimer(force=false){const btn=el('btnToggleTimer');if(!isTimerRunning||force){if(isTimerRunning&&force)clearInterval(timerInterval);isTimerRunning=true;btn.textContent='âšâš';timerInterval=setInterval(()=>{timeLeft--;updateTimerDisplay();if(timeLeft<=0){clearInterval(timerInterval);isTimerRunning=false;els.timer.classList.remove('active');new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play();sendNotification("Ù¾Ø§ÛŒØ§Ù† Ø²Ù…Ø§Ù†!","Ø¹Ø§Ø¯Øª Ø®ÙˆØ¯ Ø±Ø§ Ø«Ø¨Øª Ú©Ù†ÛŒØ¯");els.timerComplete.classList.add('active')}},1000)}else{clearInterval(timerInterval);isTimerRunning=false;btn.textContent='â–¶'}}
        function stopTimerLogic(){clearInterval(timerInterval);isTimerRunning=false;els.timer.classList.remove('active');activeTimerHabitId=null}
        function updateTimerDisplay(){el('timerDisplay').textContent=`${Math.floor(timeLeft/60).toString().padStart(2,'0')}:${(timeLeft%60).toString().padStart(2,'0')}`}
        function editHabit(id){editId=id;const h=habits.find(x=>x.id===id);el('habitName').value=h.name;el('habitFrequency').value=h.frequency;el('habitCategory').value=h.category||'other';el('habitTimer').checked=h.hasTimer;el('timerDuration').value=h.timerDuration||25;el('customDaysGroup').style.display=h.frequency==='custom'?'block':'none';el('timerSettings').style.display=h.hasTimer?'block':'none';document.querySelectorAll('.day-checkbox').forEach(c=>c.checked=h.customDays?.includes(parseInt(c.value)));document.querySelectorAll('.icon-opt').forEach(i=>i.classList.toggle('selected',i.dataset.icon===(h.icon||'target')));document.querySelectorAll('.color-opt').forEach(c=>c.classList.toggle('selected',c.dataset.color===h.color));els.modal.classList.add('active')}
        function deleteHabit(id){showConfirm('Ø­Ø°Ù Ø´ÙˆØ¯ØŸ',()=>{habits=habits.filter(x=>x.id!==id);save();renderList();renderCalendar()},'Ø­Ø°Ù',true)}
        function openNote(id){currentNoteId=id;el('noteInput').value=habits.find(x=>x.id===id).notes?.[selectedDate]||'';els.note.classList.add('active')}
        function addXP(n){userStats.xp=Math.max(0,userStats.xp+n);updateStats()}
        function updateStats(){const l=Math.floor(userStats.xp/100)+1;el('userLevel').textContent=toFarsi(l);el('xpText').textContent=`${toFarsi(userStats.xp%100)} XP`;el('xpFill').style.width=`${userStats.xp%100}%`}
        function renderCategoryManager(){const c=el('categoryList');c.innerHTML='';categories.forEach(x=>{const i=document.createElement('div');i.className='cat-item';i.innerHTML=`<div style="display:flex;align-items:center;gap:10px"><div style="width:14px;height:14px;border-radius:50%;background:${x.color}"></div>${x.name}</div><button class="btn-delete-cat" onclick="window.deleteCategory('${x.id}')">âœ•</button>`;c.appendChild(i)})}
        window.deleteCategory=(id)=>{categories=categories.filter(c=>c.id!==id);habits.forEach(h=>{if(h.category===id)h.category='other'});save();renderCategoryManager();updateCategoriesUI();renderList()}
        function showAnalytics(){els.analytics.classList.add('active');const g=el('heatmapGrid');g.innerHTML='';for(let i=100;i>=0;i--){const d=new Date();d.setDate(new Date().getDate()-i);const c=habits.filter(h=>h.completedDates?.includes(d.toISOString().split('T')[0])).length;const div=document.createElement('div');div.className='heatmap-cell';if(c>0)div.style.background=`rgba(79,70,229,${Math.min(1,c*0.4)})`;g.appendChild(div)}}
        function showConfirm(m,a,t,d){el('confirmTitle').textContent=t;el('confirmMessage').textContent=m;el('btnConfirmYes').style.background=d?'var(--danger)':'var(--primary)';pendingConfirmAction=a;els.confirm.classList.add('active')}
        function showToast(m,t='success'){els.toast.innerHTML=m;els.toast.style.borderLeft=`4px solid ${t==='error'?'#ef4444':'#10b981'}`;els.toast.classList.add('show');setTimeout(()=>els.toast.classList.remove('show'),3000)}
        function requestNotificationPermission(){if(!("Notification" in window))return showToast("Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒØ´ÙˆØ¯",'error');Notification.requestPermission().then(p=>{if(p==="granted"){showToast("ÙØ¹Ø§Ù„ Ø´Ø¯");new Notification("Ù‡Ø¨ÛŒØª ØªØ±Ú©Ø±",{body:"Ø³Ù„Ø§Ù…!"})}})}
        function sendNotification(t,b){if(Notification.permission==="granted")new Notification(t,{body:b,icon:'https://cdn-icons-png.flaticon.com/512/4305/4305432.png'})}
    </script>
</body>
</html>
